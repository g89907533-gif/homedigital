<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© - Ø§Ù„Ø¨ÙŠØª Ø§Ù„Ø±Ù‚Ù…ÙŠ</title>
    <link href="https://fonts.cdnfonts.com/css/sf-pro-display-all" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="styles.css">
    <style>
        .admin-login-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .admin-login-box {
            background: var(--glass-bg);
            backdrop-filter: var(--glass-blur);
            -webkit-backdrop-filter: var(--glass-blur);
            border: var(--glass-border);
            border-radius: var(--radius-xl);
            padding: 40px;
            width: 100%;
            max-width: 400px;
            text-align: center;
        }
        
        .admin-login-box h2 {
            color: #FF9F1C;
            margin-bottom: 24px;
            font-size: 28px;
        }
        
        .simple-paste-area {
            margin: 24px 0;
            position: relative;
        }
        
        .paste-input-simple {
            width: 100%;
            background: rgba(247, 249, 249, 0.1);
            border: 2px dashed rgba(255, 159, 28, 0.4);
            border-radius: 16px;
            padding: 20px;
            color: var(--ios-label-primary);
            font-size: 18px;
            font-family: 'SF Mono', monospace;
            text-align: center;
            letter-spacing: 3px;
            transition: all 0.3s var(--ios-spring);
            -webkit-appearance: none;
            appearance: none;
            direction: ltr;
        }
        
        .paste-input-simple:focus {
            background: rgba(247, 249, 249, 0.15);
            border-color: #FF9F1C;
            border-style: solid;
            box-shadow: 0 0 30px rgba(255, 159, 28, 0.2);
            outline: none;
        }
        
        .paste-input-simple::placeholder {
            color: var(--ios-label-tertiary);
            font-size: 14px;
            letter-spacing: normal;
            font-family: 'Cairo', sans-serif;
        }
        
        .paste-hint {
            color: var(--ios-label-tertiary);
            font-size: 13px;
            margin-top: 8px;
        }
        
        .admin-header {
            background: rgba(10, 47, 47, 0.95);
            backdrop-filter: blur(60px);
            -webkit-backdrop-filter: blur(60px);
            border-bottom: var(--glass-border);
            padding: 16px 24px;
            padding-top: calc(16px + var(--sat));
            position: sticky;
            top: 0;
            z-index: 1000;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .admin-header h1 {
            font-size: 20px;
            color: #FF9F1C;
        }
        
        .logout-btn {
            background: rgba(231, 29, 54, 0.2);
            color: var(--ios-red);
            border: 1px solid rgba(231, 29, 54, 0.3);
            padding: 8px 16px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }
        
        .logout-btn:hover {
            background: rgba(231, 29, 54, 0.4);
        }
        
        .admin-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 24px;
            padding-bottom: calc(24px + var(--sab));
        }
        
        .stats-overview {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 32px;
        }
        
        .stat-card {
            background: var(--glass-bg);
            backdrop-filter: var(--glass-blur);
            -webkit-backdrop-filter: var(--glass-blur);
            border: var(--glass-border);
            border-radius: var(--radius-lg);
            padding: 20px;
            text-align: center;
            transition: transform 0.3s var(--ios-spring);
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
        }
        
        .stat-card-icon {
            font-size: 32px;
            margin-bottom: 8px;
        }
        
        .stat-card-value {
            font-size: 28px;
            font-weight: 800;
            color: var(--ios-label-primary);
        }
        
        .stat-card-label {
            color: var(--ios-label-secondary);
            font-size: 14px;
            margin-top: 4px;
        }
        
        .admin-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 24px;
            overflow-x: auto;
            padding-bottom: 8px;
            scrollbar-width: none;
        }
        
        .admin-tabs::-webkit-scrollbar {
            display: none;
        }
        
        .admin-tab {
            background: rgba(247, 249, 249, 0.1);
            border: var(--glass-border);
            color: var(--ios-label-secondary);
            padding: 12px 24px;
            border-radius: 50px;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.3s;
            font-size: 14px;
            font-weight: 600;
        }
        
        .admin-tab.active {
            background: linear-gradient(135deg, #FF9F1C 0%, #E88D0C 100%);
            color: white;
            border-color: transparent;
        }
        
        .admin-section {
            display: none;
            animation: fadeIn 0.4s var(--ios-spring);
        }
        
        .admin-section.active {
            display: block;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-label {
            display: block;
            color: var(--ios-label-secondary);
            font-size: 14px;
            margin-bottom: 8px;
        }
        
        .image-upload-area {
            border: 2px dashed rgba(247, 249, 249, 0.25);
            border-radius: var(--radius-xl);
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: rgba(247, 249, 249, 0.05);
            position: relative;
        }
        
        .image-upload-area:hover {
            border-color: #FF9F1C;
            background: rgba(255, 159, 28, 0.1);
        }
        
        .image-preview-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 12px;
            margin-top: 16px;
        }
        
        .image-preview-item {
            position: relative;
            aspect-ratio: 1;
            border-radius: 12px;
            overflow: hidden;
            border: 2px solid #FF9F1C;
            animation: scaleIn 0.3s var(--ios-spring);
        }
        
        @keyframes scaleIn {
            from { transform: scale(0.8); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }
        
        .image-preview-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .image-preview-item .remove-img {
            position: absolute;
            top: 4px;
            right: 4px;
            width: 24px;
            height: 24px;
            background: var(--ios-red);
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.2s;
        }
        
        .image-preview-item .remove-img:hover {
            transform: scale(1.1);
        }
        
        .products-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .product-edit-item {
            background: var(--glass-bg);
            backdrop-filter: var(--glass-blur);
            -webkit-backdrop-filter: var(--glass-blur);
            border: var(--glass-border);
            border-radius: var(--radius-lg);
            padding: 16px;
            display: flex;
            gap: 16px;
            align-items: center;
            transition: transform 0.3s var(--ios-spring);
        }
        
        .product-edit-item:hover {
            transform: translateX(-5px);
        }
        
        .product-edit-img {
            width: 80px;
            height: 80px;
            border-radius: 12px;
            object-fit: cover;
            border: 2px solid rgba(255, 159, 28, 0.3);
        }
        
        .product-edit-info {
            flex: 1;
        }
        
        .product-edit-name {
            font-weight: 700;
            font-size: 16px;
            margin-bottom: 4px;
        }
        
        .product-edit-meta {
            color: var(--ios-label-tertiary);
            font-size: 13px;
        }
        
        .product-edit-price {
            color: #FF9F1C;
            font-weight: 700;
            margin-top: 4px;
        }
        
        .product-edit-actions {
            display: flex;
            gap: 8px;
        }
        
        .btn-edit {
            background: rgba(255, 159, 28, 0.2);
            color: #FF9F1C;
            border: 1px solid rgba(255, 159, 28, 0.3);
            padding: 8px 16px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.3s;
        }
        
        .btn-edit:hover {
            background: rgba(255, 159, 28, 0.4);
        }
        
        .btn-delete {
            background: rgba(231, 29, 54, 0.2);
            color: var(--ios-red);
            border: 1px solid rgba(231, 29, 54, 0.3);
            padding: 8px 16px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.3s;
        }
        
        .btn-delete:hover {
            background: rgba(231, 29, 54, 0.4);
        }
        
        .orders-filter {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
            flex-wrap: wrap;
        }
        
        .order-card-admin {
            background: var(--glass-bg);
            backdrop-filter: var(--glass-blur);
            -webkit-backdrop-filter: var(--glass-blur);
            border: var(--glass-border);
            border-radius: var(--radius-lg);
            padding: 20px;
            margin-bottom: 16px;
            transition: transform 0.3s var(--ios-spring);
        }
        
        .order-card-admin:hover {
            transform: translateY(-3px);
        }
        
        .order-header-admin {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 16px;
            padding-bottom: 16px;
            border-bottom: 1px solid rgba(247, 249, 249, 0.1);
        }
        
        .order-status-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 700;
        }
        
        .status-pending { background: rgba(255, 159, 28, 0.2); color: var(--ios-orange); }
        .status-delivered { background: rgba(46, 196, 182, 0.2); color: var(--ios-green-neon); }
        .status-cancelled { background: rgba(231, 29, 54, 0.2); color: var(--ios-red); }
        
        .order-actions-admin {
            display: flex;
            gap: 8px;
            margin-top: 16px;
        }
        
        .color-picker-admin {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
            gap: 12px;
            margin-top: 12px;
        }
        
        .color-option-admin {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            cursor: pointer;
            border: 3px solid transparent;
            transition: all 0.3s var(--ios-spring);
            position: relative;
        }
        
        .color-option-admin:hover {
            transform: scale(1.1);
        }
        
        .color-option-admin.selected {
            border-color: white;
            box-shadow: 0 0 0 3px #FF9F1C;
            transform: scale(1.15);
        }
        
        .color-option-admin.selected::after {
            content: 'âœ“';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 24px;
            font-weight: bold;
            text-shadow: 0 2px 4px rgba(0,0,0,0.5);
        }
        
        .selected-colors-admin {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 12px;
        }
        
        .selected-color-admin {
            display: flex;
            align-items: center;
            gap: 6px;
            background: rgba(0,0,0,0.3);
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 13px;
            animation: fadeIn 0.3s var(--ios-spring);
        }
        
        .category-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .category-item {
            background: var(--glass-bg);
            backdrop-filter: var(--glass-blur);
            -webkit-backdrop-filter: var(--glass-blur);
            border: var(--glass-border);
            border-radius: 12px;
            padding: 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: transform 0.3s var(--ios-spring);
        }
        
        .category-item:hover {
            transform: translateX(-5px);
        }
        
        .drag-handle {
            color: var(--ios-label-tertiary);
            cursor: grab;
            padding: 8px;
        }
        
        @media (max-width: 768px) {
            .admin-login-box {
                padding: 24px;
            }
            
            .product-edit-item {
                flex-direction: column;
                text-align: center;
            }
            
            .product-edit-img {
                width: 120px;
                height: 120px;
            }
            
            .product-edit-actions {
                width: 100%;
                justify-content: center;
            }
        }
    </style>
</head>
<body class="bg-animated">

    <div id="loginScreen" class="admin-login-container">
        <div class="admin-login-box">
            <h2>ğŸ” Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</h2>
            
            <div class="form-group">
                <input type="password" id="adminPassword" class="ios-input" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" style="text-align: center; font-size: 18px;">
            </div>
            
            <button class="ios-btn-primary" onclick="checkPassword()" style="margin-bottom: 20px;">Ø¯Ø®ÙˆÙ„</button>
            
            <div id="twoFactorSection" style="display: none;">
                <div style="width: 100%; height: 2px; background: rgba(247,249,249,0.1); margin: 20px 0;"></div>
                
                <p style="color: var(--ios-label-secondary); margin-bottom: 16px;">
                    ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø±Ù…Ø² Ø§Ù„ØªØ­Ù‚Ù‚ Ø¥Ù„Ù‰ Telegram
                </p>
                
                <div class="simple-paste-area">
                    <input type="text" 
                           id="pasteCodeInput" 
                           class="paste-input-simple" 
                           placeholder="ğŸ“‹ Ø§Ù†Ø³Ø® ÙˆØ§Ù„ØµÙ‚ Ø§Ù„ÙƒÙˆØ¯ Ù‡Ù†Ø§"
                           maxlength="18"
                           autocomplete="off"
                           oninput="handleSimplePaste(this.value)"
                           onpaste="handlePasteEvent(event)">
                    <p class="paste-hint">ÙŠÙ…ÙƒÙ†Ùƒ Ù†Ø³Ø® Ø§Ù„ÙƒÙˆØ¯ ÙƒØ§Ù…Ù„Ø§Ù‹ ÙˆØ§Ù„ØµÙ‚Ù‡ Ù…Ø¨Ø§Ø´Ø±Ø©</p>
                </div>
                
                <button class="ios-btn-success" onclick="verifySimpleCode()" style="margin-bottom: 12px;">ØªØ­Ù‚Ù‚</button>
                <button class="ios-btn-secondary" onclick="resendCode()" style="width: 100%; font-size: 13px;">
                    Ø¥Ø¹Ø§Ø¯Ø© Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ù…Ø²
                </button>
            </div>
        </div>
    </div>

    <div id="adminPanel" style="display: none;">
        <header class="admin-header">
            <h1>âš™ï¸ Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</h1>
            <button class="logout-btn" onclick="logout()">Ø®Ø±ÙˆØ¬</button>
        </header>
        
        <div class="admin-content">
            <div class="stats-overview">
                <div class="stat-card">
                    <div class="stat-card-icon">ğŸ‘ï¸</div>
                    <div class="stat-card-value" id="statVisitors">0</div>
                    <div class="stat-card-label">Ø§Ù„Ø²ÙˆØ§Ø±</div>
                </div>
                <div class="stat-card">
                    <div class="stat-card-icon">ğŸ“¦</div>
                    <div class="stat-card-value" id="statProducts">0</div>
                    <div class="stat-card-label">Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</div>
                </div>
                <div class="stat-card">
                    <div class="stat-card-icon">ğŸ›’</div>
                    <div class="stat-card-value" id="statOrders">0</div>
                    <div class="stat-card-label">Ø§Ù„Ø·Ù„Ø¨Ø§Øª</div>
                </div>
                <div class="stat-card">
                    <div class="stat-card-icon">â³</div>
                    <div class="stat-card-value" id="statPending">0</div>
                    <div class="stat-card-label">Ù…Ø¹Ù„Ù‚Ø©</div>
                </div>
            </div>
            
            <div class="admin-tabs">
                <button class="admin-tab active" onclick="showAdminTab('products', this)">Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</button>
                <button class="admin-tab" onclick="showAdminTab('add', this)">Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬</button>
                <button class="admin-tab" onclick="showAdminTab('orders', this)">Ø§Ù„Ø·Ù„Ø¨Ø§Øª</button>
                <button class="admin-tab" onclick="showAdminTab('categories', this)">Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</button>
            </div>
            
            <div id="productsSection" class="admin-section active">
                <input type="text" class="ios-input" placeholder="ğŸ” Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª..." oninput="searchProducts(this.value)" style="margin-bottom: 16px;">
                <div class="products-list" id="productsList"></div>
            </div>
            
            <div id="addSection" class="admin-section">
                <input type="hidden" id="editProductId" value="">
                
                <div class="form-group">
                    <label class="form-label">Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬</label>
                    <input type="text" id="productName" class="ios-input" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬">
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                    <div class="form-group">
                        <label class="form-label">Ø§Ù„Ø³Ø¹Ø± (Ø¯ÙŠÙ†Ø§Ø±)</label>
                        <input type="number" id="productPriceIQD" class="ios-input" placeholder="0">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Ø§Ù„Ø³Ø¹Ø± (Ø¯ÙˆÙ„Ø§Ø±)</label>
                        <input type="number" id="productPriceUSD" class="ios-input" placeholder="0">
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ</label>
                    <select id="productCategory" class="ios-select" onchange="updateSubcategories()">
                        <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù‚Ø³Ù…</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Ø§Ù„Ù‚Ø³Ù… Ø§Ù„ÙØ±Ø¹ÙŠ (Ø§Ù„Ø´Ø±ÙƒØ©)</label>
                    <select id="productSubcategory" class="ios-select">
                        <option value="">Ø¨Ø¯ÙˆÙ†</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Ø§Ù„Ø£Ù„ÙˆØ§Ù† Ø§Ù„Ù…ØªÙˆÙØ±Ø©</label>
                    <div class="color-picker-admin" id="colorPicker"></div>
                    <div class="selected-colors-admin" id="selectedColors"></div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Ø§Ù„ÙˆØµÙ</label>
                    <textarea id="productDesc" class="ios-input" rows="4" placeholder="ÙˆØµÙ Ø§Ù„Ù…Ù†ØªØ¬..."></textarea>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Ø§Ù„ØµÙˆØ±</label>
                    <div class="image-upload-area" onclick="document.getElementById('productImages').click()">
                        <p>ğŸ“¸ Ø§Ø¶ØºØ· Ù„Ø±ÙØ¹ Ø§Ù„ØµÙˆØ± Ø£Ùˆ Ø§Ø³Ø­Ø¨Ù‡Ø§ Ù‡Ù†Ø§</p>
                        <input type="file" id="productImages" hidden multiple accept="image/*" onchange="handleImageUpload(this.files)">
                    </div>
                    <div class="image-preview-grid" id="imagePreviewGrid"></div>
                </div>
                
                <button class="ios-btn-primary" onclick="saveProduct()" id="saveProductBtn">Ø­ÙØ¸ Ø§Ù„Ù…Ù†ØªØ¬</button>
                <button class="ios-btn-secondary" onclick="resetForm()" style="margin-top: 12px; width: 100%;">Ø¥Ù„ØºØ§Ø¡</button>
            </div>
            
            <div id="ordersSection" class="admin-section">
                <div class="orders-filter">
                    <button class="ios-chip active" onclick="filterOrders('all', this)">Ø§Ù„ÙƒÙ„</button>
                    <button class="ios-chip" onclick="filterOrders('pending', this)">Ù…Ø¹Ù„Ù‚Ø©</button>
                    <button class="ios-chip" onclick="filterOrders('delivered', this)">Ù…ÙˆØµÙˆÙ„Ø©</button>
                    <button class="ios-chip" onclick="filterOrders('cancelled', this)">Ù…Ù„ØºÙŠØ©</button>
                </div>
                <div id="ordersList"></div>
            </div>
            
            <div id="categoriesSection" class="admin-section">
                <div style="display: grid; grid-template-columns: 1fr auto; gap: 12px; margin-bottom: 24px;">
                    <input type="text" id="newCategoryName" class="ios-input" placeholder="Ø§Ø³Ù… Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯">
                    <button class="ios-btn-primary" onclick="addCategory()" style="width: auto; padding: 12px 24px;">Ø¥Ø¶Ø§ÙØ©</button>
                </div>
                
                <h3 style="color: #FF9F1C; margin-bottom: 16px;">Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</h3>
                <div class="category-list" id="categoriesList"></div>
                
                <div style="margin-top: 32px;">
                    <h3 style="color: var(--ios-purple); margin-bottom: 16px;">Ø¥Ø¶Ø§ÙØ© Ù‚Ø³Ù… ÙØ±Ø¹ÙŠ</h3>
                    <select id="parentCategory" class="ios-select" style="margin-bottom: 12px;">
                        <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ</option>
                    </select>
                    <div style="display: grid; grid-template-columns: 1fr auto; gap: 12px;">
                        <input type="text" id="newSubcategoryName" class="ios-input" placeholder="Ø§Ø³Ù… Ø§Ù„Ù‚Ø³Ù… Ø§Ù„ÙØ±Ø¹ÙŠ">
                        <button class="ios-btn-secondary" onclick="addSubcategory()" style="width: auto; padding: 12px 24px; background: var(--ios-purple); color: white;">Ø¥Ø¶Ø§ÙØ©</button>
                    </div>
                </div>
                
                <div class="category-list" id="subcategoriesList" style="margin-top: 24px;"></div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
        import { 
            getFirestore, 
            collection, 
            doc, 
            setDoc, 
            deleteDoc, 
            onSnapshot,
            query,
            orderBy,
            getDocs,
            getDoc,
            increment
        } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyC2f4rJBBBOe6qfa2EU1WfspUB5uibgwnM",
            authDomain: "hussain-1290b.firebaseapp.com",
            projectId: "hussain-1290b",
            storageBucket: "hussain-1290b.firebasestorage.app",
            messagingSenderId: "798281706738",
            appId: "1:798281706738:web:79314f6feb2add0bf5f46b",
            measurementId: "G-107DF3Y7ZC"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        const TELEGRAM_TOKEN = "8224453502:AAE72lDosgRpoKZwT4TQhyfRLodcsd37ID8";
        const TELEGRAM_CHAT_ID = "7769271031";

        const AVAILABLE_COLORS = [
            { name: "Ø£Ø³ÙˆØ¯", code: "#000000" },
            { name: "Ø£Ø¨ÙŠØ¶", code: "#FFFFFF" },
            { name: "Ø£Ø­Ù…Ø±", code: "#E71D36" },
            { name: "Ø£Ø²Ø±Ù‚", code: "#007AFF" },
            { name: "Ø£Ø®Ø¶Ø±", code: "#2EC4B6" },
            { name: "Ø£ØµÙØ±", code: "#FFD60A" },
            { name: "Ø¨Ø±ØªÙ‚Ø§Ù„ÙŠ", code: "#FF9F1C" },
            { name: "Ø¨Ù†ÙØ³Ø¬ÙŠ", code: "#AF52DE" },
            { name: "ÙˆØ±Ø¯ÙŠ", code: "#FF2D55" },
            { name: "Ø±Ù…Ø§Ø¯ÙŠ", code: "#8E8E93" },
            { name: "Ø¨Ù†ÙŠ", code: "#A2845E" },
            { name: "Ø°Ù‡Ø¨ÙŠ", code: "#FFD700" },
            { name: "ÙØ¶ÙŠ", code: "#C0C0C0" },
            { name: "ÙƒØ­Ù„ÙŠ", code: "#1C1C8E" },
            { name: "Ø²ÙŠØªÙˆÙ†ÙŠ", code: "#808000" }
        ];

        let products = [];
        let categories = [];
        let subcategories = [];
        let orders = [];
        let tempImages = [];
        let selectedColors = [];
        let twoFactorCode = '';
        let currentOrderFilter = 'all';
        let editingProductId = null;

        const productsRef = collection(db, "products");
        const categoriesRef = collection(db, "categories");
        const subcategoriesRef = collection(db, "subcategories");
        const ordersRef = collection(db, "orders");
        const statsRef = doc(db, "stats", "visitors");

        window.checkPassword = async function() {
            const password = document.getElementById('adminPassword').value;
            if (password !== "1111") {
                showToast("ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø®Ø§Ø·Ø¦Ø©");
                return;
            }
            
            await generateAndSendCode();
            
            document.getElementById('twoFactorSection').style.display = 'block';
            document.getElementById('pasteCodeInput').focus();
        };

        async function generateAndSendCode() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
            let code = '';
            for (let i = 0; i < 18; i++) {
                code += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            twoFactorCode = code;
            
            const msg = `ğŸ” Ø±Ù…Ø² Ø§Ù„ØªØ­Ù‚Ù‚:

${code}

ØµØ§Ù„Ø­ Ù„Ù…Ø¯Ø© 10 Ø¯Ù‚Ø§Ø¦Ù‚`;
            try {
                await fetch(`https://api.telegram.org/bot${TELEGRAM_TOKEN}/sendMessage?chat_id=${TELEGRAM_CHAT_ID}&text=${encodeURIComponent(msg)}`);
            } catch (e) {
                console.error("Failed to send code:", e);
            }
        }

        window.handleSimplePaste = function(value) {
            value = value.replace(/[^a-zA-Z0-9]/g, '').slice(0, 18);
            document.getElementById('pasteCodeInput').value = value;
            
            if (value.length === 18) {
                setTimeout(verifySimpleCode, 300);
            }
        };

        window.handlePasteEvent = function(e) {
            e.preventDefault();
            const pasted = e.clipboardData.getData('text');
            handleSimplePaste(pasted);
        };

        window.verifySimpleCode = function() {
            const entered = document.getElementById('pasteCodeInput').value;
            
            if (entered === twoFactorCode) {
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('adminPanel').style.display = 'block';
                initAdmin();
            } else {
                showToast("Ø±Ù…Ø² Ø§Ù„ØªØ­Ù‚Ù‚ ØºÙŠØ± ØµØ­ÙŠØ­");
                document.getElementById('pasteCodeInput').value = '';
                document.getElementById('pasteCodeInput').focus();
                
                document.getElementById('pasteCodeInput').style.animation = 'shake 0.5s';
                setTimeout(() => {
                    document.getElementById('pasteCodeInput').style.animation = '';
                }, 500);
            }
        };

        window.resendCode = async function() {
            await generateAndSendCode();
            showToast("ØªÙ… Ø¥Ø¹Ø§Ø¯Ø© Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ù…Ø²");
        };

        function initAdmin() {
            setupColorPicker();
            
            onSnapshot(productsRef, (snapshot) => {
                products = [];
                snapshot.forEach((doc) => {
                    if (doc.id !== "init") {
                        products.push({ id: doc.id, ...doc.data() });
                    }
                });
                renderProductsList();
                document.getElementById('statProducts').innerText = products.length;
            });

            onSnapshot(categoriesRef, (snapshot) => {
                categories = [];
                snapshot.forEach((doc) => {
                    if (doc.id !== "init") {
                        categories.push(doc.data().name);
                    }
                });
                updateCategorySelects();
                renderCategoriesList();
            });

            onSnapshot(subcategoriesRef, (snapshot) => {
                subcategories = [];
                snapshot.forEach((doc) => {
                    if (doc.id !== "init") {
                        subcategories.push({ id: doc.id, ...doc.data() });
                    }
                });
                renderSubcategoriesList();
            });

            onSnapshot(ordersRef, (snapshot) => {
                orders = [];
                snapshot.forEach((doc) => {
                    if (doc.id !== "init") {
                        orders.push({ id: doc.id, ...doc.data() });
                    }
                });
                renderOrdersList();
                document.getElementById('statOrders').innerText = orders.length;
                document.getElementById('statPending').innerText = orders.filter(o => o.status === 'pending').length;
            });

            onSnapshot(statsRef, (doc) => {
                if (doc.exists()) {
                    document.getElementById('statVisitors').innerText = doc.data().count || 0;
                }
            });
        }

        function setupColorPicker() {
            const picker = document.getElementById('colorPicker');
            picker.innerHTML = AVAILABLE_COLORS.map(color => `
                <div class="color-option-admin" 
                     style="background-color: ${color.code}; ${color.code === '#FFFFFF' ? 'border: 2px solid rgba(0,0,0,0.2);' : ''}"
                     data-name="${color.name}"
                     data-code="${color.code}"
                     onclick="toggleColor('${color.name}', '${color.code}', this)">
                </div>
            `).join('');
        }

        window.toggleColor = function(name, code, element) {
            const index = selectedColors.findIndex(c => c.name === name);
            if (index > -1) {
                selectedColors.splice(index, 1);
                element.classList.remove('selected');
            } else {
                selectedColors.push({ name, code });
                element.classList.add('selected');
            }
            renderSelectedColors();
        };

        function renderSelectedColors() {
            const container = document.getElementById('selectedColors');
            if (selectedColors.length === 0) {
                container.innerHTML = '';
                return;
            }
            
            container.innerHTML = selectedColors.map((color, index) => `
                <div class="selected-color-admin">
                    <div style="width: 16px; height: 16px; border-radius: 50%; background: ${color.code}; ${color.code === '#FFFFFF' ? 'border: 1px solid rgba(0,0,0,0.3);' : ''}"></div>
                    <span>${color.name}</span>
                    <button onclick="removeColor(${index})" style="background: none; border: none; color: var(--ios-red); cursor: pointer; font-size: 16px;">Ã—</button>
                </div>
            `).join('');
        }

        window.removeColor = function(index) {
            const color = selectedColors[index];
            selectedColors.splice(index, 1);
            
            document.querySelectorAll('.color-option-admin').forEach(opt => {
                if (opt.dataset.name === color.name) {
                    opt.classList.remove('selected');
                }
            });
            
            renderSelectedColors();
        };

        function updateCategorySelects() {
            const productCat = document.getElementById('productCategory');
            const parentCat = document.getElementById('parentCategory');
            
            const options = categories.map(c => `<option value="${c}">${c}</option>`).join('');
            
            productCat.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ù‚Ø³Ù…</option>' + options;
            parentCat.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ</option>' + options;
        }

        window.updateSubcategories = function() {
            const mainCat = document.getElementById('productCategory').value;
            const subCatSelect = document.getElementById('productSubcategory');
            
            const filtered = subcategories.filter(s => s.parentCategory === mainCat);
            subCatSelect.innerHTML = '<option value="">Ø¨Ø¯ÙˆÙ†</option>' + 
                filtered.map(s => `<option value="${s.name}">${s.name}</option>`).join('');
        };

        window.handleImageUpload = function(files) {
            if (tempImages.length + files.length > 5) {
                showToast("Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ 5 ØµÙˆØ±");
                return;
            }

            Array.from(files).forEach(file => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const MAX_WIDTH = 1200;
                        let width = img.width;
                        let height = img.height;

                        if (width > MAX_WIDTH) {
                            height = height * MAX_WIDTH / width;
                            width = MAX_WIDTH;
                        }

                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);

                        tempImages.push(canvas.toDataURL('image/jpeg', 0.7));
                        renderImagePreviews();
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            });
        };

        function renderImagePreviews() {
            const grid = document.getElementById('imagePreviewGrid');
            grid.innerHTML = tempImages.map((src, index) => `
                <div class="image-preview-item">
                    <img src="${src}" alt="Preview">
                    <button class="remove-img" onclick="removeImage(${index})">Ã—</button>
                </div>
            `).join('');
        }

        window.removeImage = function(index) {
            tempImages.splice(index, 1);
            renderImagePreviews();
        };

        window.saveProduct = async function() {
            const name = document.getElementById('productName').value.trim();
            const priceIQD = document.getElementById('productPriceIQD').value;
            const priceUSD = document.getElementById('productPriceUSD').value;
            const cat = document.getElementById('productCategory').value;
            const subCat = document.getElementById('productSubcategory').value;
            const desc = document.getElementById('productDesc').value;

            if (!name || !cat) {
                showToast("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ù„Ù‚Ø³Ù…");
                return;
            }

            const productData = {
                name,
                priceIQD: priceIQD ? parseFloat(priceIQD) : 0,
                priceUSD: priceUSD ? parseFloat(priceUSD) : 0,
                cat,
                subCat: subCat || null,
                desc,
                images: tempImages,
                colors: selectedColors,
                updatedAt: new Date().toISOString()
            };

            try {
                if (editingProductId) {
                    await setDoc(doc(db, "products", editingProductId), productData, { merge: true });
                    showToast("ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ù†ØªØ¬");
                } else {
                    const newRef = doc(productsRef);
                    productData.id = newRef.id;
                    productData.createdAt = new Date().toISOString();
                    await setDoc(newRef, productData);
                    showToast("ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù†ØªØ¬");
                }
                
                resetForm();
                showAdminTab('products', document.querySelectorAll('.admin-tab')[0]);
            } catch (error) {
                console.error("Save error:", error);
                showToast("Ø­Ø¯Ø« Ø®Ø·Ø£");
            }
        };

        window.resetForm = function() {
            document.getElementById('editProductId').value = '';
            document.getElementById('productName').value = '';
            document.getElementById('productPriceIQD').value = '';
            document.getElementById('productPriceUSD').value = '';
            document.getElementById('productCategory').value = '';
            document.getElementById('productSubcategory').value = '';
            document.getElementById('productDesc').value = '';
            
            tempImages = [];
            selectedColors = [];
            editingProductId = null;
            
            document.querySelectorAll('.color-option-admin').forEach(opt => opt.classList.remove('selected'));
            renderImagePreviews();
            renderSelectedColors();
            
            document.getElementById('saveProductBtn').innerText = 'Ø­ÙØ¸ Ø§Ù„Ù…Ù†ØªØ¬';
        };

        function renderProductsList() {
            const list = document.getElementById('productsList');
            list.innerHTML = products.map(p => `
                <div class="product-edit-item">
                    ${p.images?.[0] ? `<img src="${p.images[0]}" class="product-edit-img" onerror="this.style.display='none'">` : '<div style="width: 80px; height: 80px; background: rgba(255,255,255,0.1); border-radius: 12px; display: flex; align-items: center; justify-content: center; color: var(--ios-label-tertiary);">Ù„Ø§ ØµÙˆØ±Ø©</div>'}
                    <div class="product-edit-info">
                        <div class="product-edit-name">${p.name}</div>
                        <div class="product-edit-meta">${p.cat}${p.subCat ? ' > ' + p.subCat : ''}</div>
                        <div class="product-edit-price">${p.priceIQD ? p.priceIQD.toLocaleString() + ' Ø¯.Ø¹' : ''}</div>
                    </div>
                    <div class="product-edit-actions">
                        <button class="btn-edit" onclick="editProduct('${p.id}')">ØªØ¹Ø¯ÙŠÙ„</button>
                        <button class="btn-delete" onclick="deleteProduct('${p.id}')">Ø­Ø°Ù</button>
                    </div>
                </div>
            `).join('');
        }

        window.editProduct = function(id) {
            const p = products.find(prod => prod.id === id);
            if (!p) return;

            editingProductId = id;
            
            document.getElementById('editProductId').value = id;
            document.getElementById('productName').value = p.name;
            document.getElementById('productPriceIQD').value = p.priceIQD || '';
            document.getElementById('productPriceUSD').value = p.priceUSD || '';
            document.getElementById('productCategory').value = p.cat || '';
            updateSubcategories();
            document.getElementById('productSubcategory').value = p.subCat || '';
            document.getElementById('productDesc').value = p.desc || '';
            
            tempImages = p.images ? [...p.images] : [];
            selectedColors = p.colors ? [...p.colors] : [];
            
            document.querySelectorAll('.color-option-admin').forEach(opt => {
                if (selectedColors.find(c => c.name === opt.dataset.name)) {
                    opt.classList.add('selected');
                } else {
                    opt.classList.remove('selected');
                }
            });
            
            renderImagePreviews();
            renderSelectedColors();
            
            document.getElementById('saveProductBtn').innerText = 'ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ù†ØªØ¬';
            showAdminTab('add', document.querySelectorAll('.admin-tab')[1]);
        };

        window.deleteProduct = async function(id) {
            if (!confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…Ù†ØªØ¬ØŸ")) return;
            
            try {
                await deleteDoc(doc(db, "products", id));
                showToast("ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ù†ØªØ¬");
            } catch (error) {
                console.error("Delete error:", error);
                showToast("Ø­Ø¯Ø« Ø®Ø·Ø£");
            }
        };

        window.searchProducts = function(query) {
            const items = document.querySelectorAll('.product-edit-item');
            const lowerQuery = query.toLowerCase();
            
            items.forEach(item => {
                const name = item.querySelector('.product-edit-name').innerText.toLowerCase();
                item.style.display = name.includes(lowerQuery) ? 'flex' : 'none';
            });
        };

        window.filterOrders = function(status, btn) {
            currentOrderFilter = status;
            document.querySelectorAll('.orders-filter .ios-chip').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            renderOrdersList();
        };

        function renderOrdersList() {
            const container = document.getElementById('ordersList');
            
            let filtered = orders;
            if (currentOrderFilter !== 'all') {
                filtered = orders.filter(o => o.status === currentOrderFilter);
            }
            
            container.innerHTML = filtered.map(order => {
                const date = new Date(order.createdAt).toLocaleString('ar-IQ');
                const statusClass = order.status === 'pending' ? 'status-pending' : order.status === 'delivered' ? 'status-delivered' : 'status-cancelled';
                const statusText = order.status === 'pending' ? 'Ù…Ø¹Ù„Ù‚Ø©' : order.status === 'delivered' ? 'Ù…ÙˆØµÙˆÙ„Ø©' : 'Ù…Ù„ØºÙŠØ©';
                
                return `
                    <div class="order-card-admin">
                        <div class="order-header-admin">
                            <div>
                                <div style="font-weight: 700; font-size: 16px;">Ø·Ù„Ø¨ #${order.id.slice(-6)}</div>
                                <div style="color: var(--ios-label-tertiary); font-size: 13px; margin-top: 4px;">${date}</div>
                            </div>
                            <span class="order-status-badge ${statusClass}">${statusText}</span>
                        </div>
                        
                        <div style="margin-bottom: 12px;">
                            <div style="display: flex; gap: 8px; margin-bottom: 8px;">
                                <i class="fas fa-user" style="color: #FF9F1C; width: 20px;"></i>
                                <span>${order.customerName}</span>
                            </div>
                            <div style="display: flex; gap: 8px; margin-bottom: 8px;">
                                <i class="fas fa-phone" style="color: #FF9F1C; width: 20px;"></i>
                                <span>${order.customerPhone}</span>
                            </div>
                            <div style="display: flex; gap: 8px;">
                                <i class="fas fa-map-marker-alt" style="color: #FF9F1C; width: 20px;"></i>
                                <span>${order.province} - ${order.customerAddress}</span>
                            </div>
                        </div>
                        
                        <div style="background: rgba(0,0,0,0.2); border-radius: 8px; padding: 12px; margin-bottom: 12px;">
                            ${order.items.map(item => `
                                <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                                    <span>${item.name}</span>
                                    <span>x${item.qty}</span>
                                </div>
                            `).join('')}
                            <div style="border-top: 1px solid rgba(255,255,255,0.1); margin-top: 8px; padding-top: 8px; display: flex; justify-content: space-between; font-weight: 700;">
                                <span>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ:</span>
                                <span style="color: var(--ios-green-neon);">${order.totalAmount?.toLocaleString() || 0} Ø¯.Ø¹</span>
                            </div>
                        </div>
                        
                        ${order.status === 'pending' ? `
                            <div class="order-actions-admin">
                                <button class="ios-btn-success" onclick="updateOrderStatus('${order.id}', 'delivered')" style="flex: 1;">âœ… ØªÙ… Ø§Ù„ØªÙˆØµÙŠÙ„</button>
                                <button class="btn-delete" onclick="updateOrderStatus('${order.id}', 'cancelled')" style="flex: 1;">âŒ Ø¥Ù„ØºØ§Ø¡</button>
                            </div>
                        ` : `
                            <button class="btn-delete" onclick="deleteOrder('${order.id}')" style="width: 100%;">ğŸ—‘ï¸ Ø­Ø°Ù Ù†Ù‡Ø§Ø¦ÙŠ</button>
                        `}
                    </div>
                `;
            }).join('') || '<p style="text-align: center; color: var(--ios-label-tertiary); padding: 40px;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª</p>';
        }

        window.updateOrderStatus = async function(id, status) {
            try {
                await setDoc(doc(db, "orders", id), { status, updatedAt: new Date().toISOString() }, { merge: true });
                showToast(status === 'delivered' ? "ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø©" : "ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø·Ù„Ø¨");
            } catch (error) {
                console.error("Update error:", error);
                showToast("Ø­Ø¯Ø« Ø®Ø·Ø£");
            }
        };

        window.deleteOrder = async function(id) {
            if (!confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø·Ù„Ø¨ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ØŸ")) return;
            
            try {
                await deleteDoc(doc(db, "orders", id));
                showToast("ØªÙ… Ø­Ø°Ù Ø§Ù„Ø·Ù„Ø¨");
            } catch (error) {
                console.error("Delete error:", error);
                showToast("Ø­Ø¯Ø« Ø®Ø·Ø£");
            }
        };

        window.addCategory = async function() {
            const name = document.getElementById('newCategoryName').value.trim();
            if (!name) return;
            
            try {
                await setDoc(doc(categoriesRef, name), { name, createdAt: new Date().toISOString() });
                document.getElementById('newCategoryName').value = '';
                showToast("ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù‚Ø³Ù…");
            } catch (error) {
                console.error("Add category error:", error);
                showToast("Ø­Ø¯Ø« Ø®Ø·Ø£");
            }
        };

        window.addSubcategory = async function() {
            const parent = document.getElementById('parentCategory').value;
            const name = document.getElementById('newSubcategoryName').value.trim();
            
            if (!parent || !name) {
                showToast("ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ ÙˆØ¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø§Ø³Ù…");
                return;
            }
            
            try {
                await setDoc(doc(subcategoriesRef, parent + '_' + name), { 
                    name, 
                    parentCategory: parent,
                    createdAt: new Date().toISOString() 
                });
                document.getElementById('newSubcategoryName').value = '';
                showToast("ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù‚Ø³Ù… Ø§Ù„ÙØ±Ø¹ÙŠ");
            } catch (error) {
                console.error("Add subcategory error:", error);
                showToast("Ø­Ø¯Ø« Ø®Ø·Ø£");
            }
        };

        function renderCategoriesList() {
            const list = document.getElementById('categoriesList');
            list.innerHTML = categories.map(cat => `
                <div class="category-item">
                    <span style="font-weight: 600;">${cat}</span>
                    <button onclick="deleteCategory('${cat}')" style="background: none; border: none; color: var(--ios-red); cursor: pointer; font-size: 18px;">ğŸ—‘ï¸</button>
                </div>
            `).join('') || '<p style="color: var(--ios-label-tertiary);">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ù‚Ø³Ø§Ù…</p>';
        }

        function renderSubcategoriesList() {
            const list = document.getElementById('subcategoriesList');
            list.innerHTML = subcategories.map(sub => `
                <div class="category-item">
                    <div>
                        <span style="font-weight: 600;">${sub.name}</span>
                        <span style="color: var(--ios-label-tertiary); font-size: 13px; display: block;">ØªÙ†ØªÙ…ÙŠ Ø¥Ù„Ù‰: ${sub.parentCategory}</span>
                    </div>
                    <button onclick="deleteSubcategory('${sub.id}')" style="background: none; border: none; color: var(--ios-red); cursor: pointer; font-size: 18px;">ğŸ—‘ï¸</button>
                </div>
            `).join('') || '<p style="color: var(--ios-label-tertiary);">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ù‚Ø³Ø§Ù… ÙØ±Ø¹ÙŠØ©</p>';
        }

        window.deleteCategory = async function(name) {
            if (!confirm(`Ø­Ø°Ù Ø§Ù„Ù‚Ø³Ù… "${name}"ØŸ`)) return;
            
            try {
                await deleteDoc(doc(categoriesRef, name));
                showToast("ØªÙ… Ø­Ø°Ù Ø§Ù„Ù‚Ø³Ù…");
            } catch (error) {
                console.error("Delete error:", error);
                showToast("Ø­Ø¯Ø« Ø®Ø·Ø£");
            }
        };

        window.deleteSubcategory = async function(id) {
            if (!confirm("Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù‚Ø³Ù… Ø§Ù„ÙØ±Ø¹ÙŠØŸ")) return;
            
            try {
                await deleteDoc(doc(subcategoriesRef, id));
                showToast("ØªÙ… Ø§Ù„Ø­Ø°Ù");
            } catch (error) {
                console.error("Delete error:", error);
                showToast("Ø­Ø¯Ø« Ø®Ø·Ø£");
            }
        };

        window.showAdminTab = function(tab, btn) {
            document.querySelectorAll('.admin-section').forEach(s => s.classList.remove('active'));
            document.getElementById(tab + 'Section').classList.add('active');
            
            document.querySelectorAll('.admin-tab').forEach(t => t.classList.remove('active'));
            btn.classList.add('active');
        };

        window.logout = function() {
            location.reload();
        };

        function showToast(message) {
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                left: 50%;
                transform: translateX(-50%);
                background: rgba(20, 60, 60, 0.95);
                backdrop-filter: blur(20px);
                color: white;
                padding: 14px 28px;
                border-radius: 50px;
                font-weight: 600;
                z-index: 9999;
                animation: slideDown 0.3s ease;
            `;
            toast.innerText = message;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.remove();
            }, 3000);
        }

        const style = document.createElement('style');
        style.innerHTML = `
            @keyframes shake {
                0%, 100% { transform: translateX(0); }
                25% { transform: translateX(-10px); }
                75% { transform: translateX(10px); }
            }
            @keyframes slideDown {
                from { transform: translateX(-50%) translateY(-100%); opacity: 0; }
                to { transform: translateX(-50%) translateY(0); opacity: 1; }
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>