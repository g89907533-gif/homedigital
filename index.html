<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="format-detection" content="telephone=no">
    <meta name="theme-color" content="#0A2F2F">
    <title>Ø§Ù„Ø¨ÙŠØª Ø§Ù„Ø±Ù‚Ù…ÙŠ - Al-Bayt Al-Raqmi</title>
    <link href="https://fonts.cdnfonts.com/css/sf-pro-display-all" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="styles.css">
    <style>
        /* Additional styles for new product card design */
        .product-card-actions {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }

        .product-card-actions button {
            flex: 1;
            padding: 10px;
            border-radius: 12px;
            font-size: 13px;
            font-weight: 700;
            border: none;
            cursor: pointer;
            transition: all 0.3s var(--ios-spring);
        }

        .btn-add-cart {
            background: rgba(255, 159, 28, 0.2);
            color: #FF9F1C;
            border: 1px solid rgba(255, 159, 28, 0.3);
        }

        .btn-add-cart:hover {
            background: #FF9F1C;
            color: white;
        }

        .btn-quick-buy {
            background: rgba(46, 196, 182, 0.2);
            color: var(--ios-green-neon);
            border: 1px solid rgba(46, 196, 182, 0.3);
        }

        .btn-quick-buy:hover {
            background: var(--ios-green-neon);
            color: white;
        }

        .product-description {
            margin: 8px 0;
            position: relative;
        }

        .product-description-text {
            font-size: 13px;
            color: var(--ios-label-secondary);
            line-height: 1.5;
            overflow: hidden;
            transition: max-height 0.4s var(--ios-spring);
        }

        .product-description-text.collapsed {
            max-height: 2.8em;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
        }

        .product-description-text.expanded {
            max-height: 200px;
            -webkit-line-clamp: unset;
        }

        .show-more-btn {
            background: transparent;
            border: none;
            color: #FF9F1C;
            font-size: 12px;
            font-weight: 700;
            cursor: pointer;
            padding: 4px 0;
            margin-top: 4px;
            display: inline-flex;
            align-items: center;
            gap: 4px;
            transition: all 0.3s var(--ios-spring);
        }

        .show-more-btn:hover {
            color: #FFB347;
            gap: 8px;
        }

        .show-more-btn::after {
            content: 'â€º';
            font-size: 14px;
            transition: transform 0.3s var(--ios-spring);
        }

        .show-more-btn.expanded::after {
            transform: rotate(90deg);
        }

        .product-card-footer {
            margin-top: auto;
            padding-top: 12px;
            border-top: 1px solid rgba(247, 249, 249, 0.1);
        }

        /* Admin access hidden indicator */
        .admin-access-hint {
            position: fixed;
            bottom: 20px;
            left: 20px;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: rgba(255, 159, 28, 0.3);
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 100;
        }

        .admin-access-hint.visible {
            opacity: 1;
        }

        /* Two factor modal */
        .two-factor-modal {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.95);
            backdrop-filter: blur(30px);
            z-index: 5000;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
            opacity: 0;
            transition: opacity 0.4s var(--ios-spring);
        }

        .two-factor-modal.active {
            opacity: 1;
        }

        .two-factor-content {
            background: var(--glass-bg);
            backdrop-filter: blur(60px) saturate(250%);
            border: var(--glass-border);
            border-radius: var(--radius-xl);
            padding: 40px;
            text-align: center;
            max-width: 400px;
            width: 100%;
            transform: scale(0.9) translateY(40px);
            transition: transform 0.5s var(--ios-spring-bounce);
        }

        .two-factor-modal.active .two-factor-content {
            transform: scale(1) translateY(0);
        }

        .code-input {
            width: 100%;
            background: rgba(247, 249, 249, 0.1);
            border: 2px dashed rgba(255, 159, 28, 0.4);
            border-radius: 16px;
            padding: 20px;
            color: var(--ios-label-primary);
            font-size: 24px;
            font-family: 'SF Mono', monospace;
            text-align: center;
            letter-spacing: 8px;
            margin: 20px 0;
            transition: all 0.3s var(--ios-spring);
            direction: ltr;
        }

        .code-input:focus {
            background: rgba(247, 249, 249, 0.15);
            border-color: #FF9F1C;
            border-style: solid;
            box-shadow: 0 0 30px rgba(255, 159, 28, 0.2);
            outline: none;
        }

        .code-hint {
            color: var(--ios-label-tertiary);
            font-size: 13px;
            margin-top: 8px;
        }

        /* Clickable card overlay */
        .card-click-overlay {
            position: absolute;
            inset: 0;
            z-index: 1;
            cursor: pointer;
        }

        .ios-product-card {
            position: relative;
        }

        .card-content-wrapper {
            position: relative;
            z-index: 2;
            pointer-events: none;
        }

        .card-content-wrapper .product-card-actions,
        .card-content-wrapper .show-more-btn {
            pointer-events: auto;
        }

        /* ===== NEW PRODUCT DETAIL MODAL STYLES ===== */
        .product-detail-modal-new {
            max-width: 900px;
            width: 95%;
            max-height: 90vh;
            overflow-y: auto;
            background: var(--glass-bg);
            backdrop-filter: blur(60px) saturate(250%);
            -webkit-backdrop-filter: blur(60px) saturate(250%);
            border: var(--glass-border);
            border-radius: var(--radius-xl);
            position: relative;
        }

        .product-detail-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0;
            min-height: 500px;
        }

        @media (max-width: 768px) {
            .product-detail-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Image Gallery Grid */
        .product-gallery-section {
            padding: 24px;
            background: rgba(0, 0, 0, 0.2);
            border-left: 1px solid rgba(247, 249, 249, 0.1);
        }

        @media (max-width: 768px) {
            .product-gallery-section {
                border-left: none;
                border-bottom: 1px solid rgba(247, 249, 249, 0.1);
            }
        }

        .image-grid-container {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 16px;
        }

        .image-grid-item {
            position: relative;
            aspect-ratio: 1;
            border-radius: 16px;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.4s var(--ios-spring);
            border: 2px solid transparent;
            background: rgba(247, 249, 249, 0.05);
        }

        .image-grid-item:hover {
            transform: scale(1.05);
            border-color: #FF9F1C;
            box-shadow: 0 10px 30px rgba(255, 159, 28, 0.3);
            z-index: 10;
        }

        .image-grid-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.4s var(--ios-spring);
        }

        .image-grid-item:hover img {
            transform: scale(1.1);
        }

        .image-grid-item .image-overlay {
            position: absolute;
            inset: 0;
            background: rgba(0, 0, 0, 0);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s var(--ios-spring);
        }

        .image-grid-item:hover .image-overlay {
            background: rgba(0, 0, 0, 0.3);
        }

        .image-grid-item .zoom-icon {
            width: 50px;
            height: 50px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #0A2F2F;
            font-size: 20px;
            opacity: 0;
            transform: scale(0.5);
            transition: all 0.3s var(--ios-spring-bounce);
        }

        .image-grid-item:hover .zoom-icon {
            opacity: 1;
            transform: scale(1);
        }

        .image-counter-badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: rgba(255, 159, 28, 0.2);
            color: #FF9F1C;
            padding: 8px 16px;
            border-radius: 50px;
            font-size: 14px;
            font-weight: 600;
            margin-top: 8px;
        }

        /* Product Info Section */
        .product-info-section-new {
            padding: 32px;
            display: flex;
            flex-direction: column;
        }

        .product-header-new {
            margin-bottom: 24px;
            padding-bottom: 20px;
            border-bottom: 1px solid rgba(247, 249, 249, 0.1);
        }

        .product-category-badges {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
            flex-wrap: wrap;
        }

        .badge-new {
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .badge-category {
            background: linear-gradient(135deg, rgba(255, 159, 28, 0.2), rgba(255, 159, 28, 0.1));
            color: #FF9F1C;
            border: 1px solid rgba(255, 159, 28, 0.3);
        }

        .badge-subcategory {
            background: linear-gradient(135deg, rgba(90, 154, 154, 0.2), rgba(90, 154, 154, 0.1));
            color: var(--ios-purple);
            border: 1px solid rgba(90, 154, 154, 0.3);
        }

        .product-title-new {
            font-size: 28px;
            font-weight: 800;
            color: var(--ios-label-primary);
            line-height: 1.3;
            margin-bottom: 8px;
        }

        .product-price-new {
            display: flex;
            align-items: baseline;
            gap: 12px;
            margin-top: 16px;
        }

        .price-main {
            font-size: 32px;
            font-weight: 900;
            color: #FF9F1C;
            background: linear-gradient(135deg, #FF9F1C, #FFB347);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .price-secondary {
            font-size: 18px;
            color: var(--ios-label-tertiary);
            text-decoration: line-through;
            opacity: 0.7;
        }

        /* Details List */
        .details-list {
            display: flex;
            flex-direction: column;
            gap: 16px;
            margin-bottom: 24px;
        }

        .detail-item {
            display: flex;
            align-items: flex-start;
            gap: 16px;
            padding: 16px;
            background: rgba(247, 249, 249, 0.05);
            border-radius: 16px;
            border: 1px solid rgba(247, 249, 249, 0.08);
            transition: all 0.3s var(--ios-spring);
        }

        .detail-item:hover {
            background: rgba(247, 249, 249, 0.08);
            transform: translateX(-5px);
            border-color: rgba(255, 159, 28, 0.2);
        }

        .detail-icon {
            width: 44px;
            height: 44px;
            background: linear-gradient(135deg, rgba(255, 159, 28, 0.2), rgba(255, 159, 28, 0.1));
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            color: #FF9F1C;
            flex-shrink: 0;
        }

        .detail-icon.description-icon {
            background: linear-gradient(135deg, rgba(46, 196, 182, 0.2), rgba(46, 196, 182, 0.1));
            color: var(--ios-green-neon);
        }

        .detail-icon.colors-icon {
            background: linear-gradient(135deg, rgba(175, 82, 222, 0.2), rgba(175, 82, 222, 0.1));
            color: #AF52DE;
        }

        .detail-content {
            flex: 1;
        }

        .detail-label {
            font-size: 13px;
            color: var(--ios-label-tertiary);
            margin-bottom: 4px;
            font-weight: 600;
        }

        .detail-value {
            font-size: 15px;
            color: var(--ios-label-primary);
            line-height: 1.6;
            font-weight: 500;
        }

        /* Colors Grid in Detail */
        .colors-grid-detail {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 8px;
        }

        .color-item-detail {
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(0, 0, 0, 0.3);
            padding: 8px 14px;
            border-radius: 50px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s var(--ios-spring);
        }

        .color-item-detail:hover {
            transform: scale(1.05);
            border-color: rgba(255, 255, 255, 0.3);
        }

        .color-dot-detail {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 2px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }

        .color-name-detail {
            font-size: 13px;
            font-weight: 600;
        }

        /* Action Buttons */
        .product-actions-new {
            margin-top: auto;
            padding-top: 24px;
            border-top: 1px solid rgba(247, 249, 249, 0.1);
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .action-btn {
            width: 100%;
            padding: 16px 24px;
            border-radius: 16px;
            font-size: 16px;
            font-weight: 700;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: all 0.3s var(--ios-spring);
        }

        .action-btn-primary {
            background: linear-gradient(135deg, #FF9F1C 0%, #E88D0C 100%);
            color: white;
            box-shadow: 0 8px 30px rgba(255, 159, 28, 0.4);
        }

        .action-btn-primary:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 40px rgba(255, 159, 28, 0.5);
        }

        .action-btn-secondary {
            background: rgba(46, 196, 182, 0.15);
            color: var(--ios-green-neon);
            border: 2px solid rgba(46, 196, 182, 0.3);
        }

        .action-btn-secondary:hover {
            background: var(--ios-green-neon);
            color: white;
            transform: translateY(-3px);
            box-shadow: 0 8px 30px rgba(46, 196, 182, 0.4);
        }

        /* Close Button */
        .modal-close-btn-new {
            position: absolute;
            top: 20px;
            left: 20px;
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: rgba(247, 249, 249, 0.1);
            border: 1px solid rgba(247, 249, 249, 0.2);
            color: var(--ios-label-secondary);
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s var(--ios-spring);
            z-index: 100;
            backdrop-filter: blur(10px);
        }

        .modal-close-btn-new:hover {
            background: rgba(231, 29, 54, 0.8);
            color: white;
            transform: rotate(90deg);
        }

        @media (max-width: 768px) {
            .product-detail-modal-new {
                width: 100%;
                height: 100%;
                max-height: 100vh;
                border-radius: 0;
            }

            .product-info-section-new {
                padding: 20px;
            }

            .product-title-new {
                font-size: 22px;
            }

            .price-main {
                font-size: 26px;
            }

            .image-grid-container {
                grid-template-columns: repeat(2, 1fr);
                gap: 8px;
            }

            .detail-item {
                padding: 12px;
            }
        }
    </style>
</head>
<body class="bg-animated">

    <!-- Firebase Loading Screen -->
    <div id="firebaseLoading" class="firebase-loading">
        <div class="firebase-loading-spinner"></div>
        <div class="firebase-loading-text">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ØªØ¬Ø±...</div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="ios-toast"></div>
    
    <!-- Sync Status -->
    <div id="syncStatus" class="sync-status offline">
        <div class="sync-dot"></div>
        <span id="syncText">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„...</span>
    </div>

    <!-- Success Modal -->
    <div id="successModal" class="success-modal" onclick="closeSuccessModal(event)">
        <div class="success-content" onclick="event.stopPropagation()">
            <div class="success-icon">âœ“</div>
            <h2 class="success-title">ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨Ùƒ Ø¨Ù†Ø¬Ø§Ø­!</h2>
            <p class="success-text">
                ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨Ùƒ Ø¥Ù„Ù‰ <span style="color: #FF9F1C; font-weight: 700;">Ø§Ù„Ø¨ÙŠØª Ø§Ù„Ø±Ù‚Ù…ÙŠ</span><br>
                Ø§Ù†ØªØ¸Ø± <span style="color: #FF9F1C; font-weight: 700;">ØºØ¯Ø§Ù‹ Ø£Ùˆ Ø¨Ø¹Ø¯ ØºØ¯</span> Ù„ÙˆØµÙˆÙ„ Ø·Ù„Ø¨Ùƒ<br>
                Ø³Ù†ØªÙˆØ§ØµÙ„ Ù…Ø¹Ùƒ Ù‚Ø±ÙŠØ¨Ø§Ù‹ Ù„Ù„ØªØ£ÙƒÙŠØ¯
            </p>
            <button class="ios-btn-success" onclick="closeSuccessModal()" style="margin-top: 20px;">Ø­Ø³Ù†Ø§Ù‹ØŒ Ø´ÙƒØ±Ø§Ù‹</button>
        </div>
    </div>

    <!-- Two Factor Modal -->
    <div id="twoFactorModal" class="two-factor-modal" onclick="closeTwoFactor(event)">
        <div class="two-factor-content" onclick="event.stopPropagation()">
            <h2 style="color: #FF9F1C; margin-bottom: 16px;">ğŸ” Ø§Ù„ØªØ­Ù‚Ù‚ Ø¨Ø®Ø·ÙˆØªÙŠÙ†</h2>
            <p style="color: var(--ios-label-secondary); margin-bottom: 20px;">
                ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø±Ù…Ø² Ø§Ù„ØªØ­Ù‚Ù‚ Ø¥Ù„Ù‰ Telegram<br>
                Ø§Ù†Ø³Ø® ÙˆØ§Ù„ØµÙ‚ Ø§Ù„ÙƒÙˆØ¯ Ù‡Ù†Ø§
            </p>
            
            <input type="text" 
                   id="twoFactorCode" 
                   class="code-input" 
                   placeholder="------"
                   maxlength="18"
                   oninput="handleCodeInput(this.value)"
                   onpaste="handleCodePaste(event)">
            
            <p class="code-hint">ÙŠÙ…ÙƒÙ†Ùƒ Ù†Ø³Ø® Ø§Ù„ÙƒÙˆØ¯ ÙƒØ§Ù…Ù„Ø§Ù‹ ÙˆØ§Ù„ØµÙ‚Ù‡ Ù…Ø¨Ø§Ø´Ø±Ø©</p>
            
            <button class="ios-btn-primary" onclick="verifyCode()" style="margin-bottom: 12px;">ØªØ­Ù‚Ù‚</button>
            <button class="ios-btn-secondary" onclick="closeTwoFactor()" style="width: 100%;">Ø¥Ù„ØºØ§Ø¡</button>
        </div>
    </div>

    <!-- Image Lightbox -->
    <div id="lightbox" class="lightbox" onclick="closeLightbox(event)">
        <button class="lightbox-close" onclick="closeLightbox()">Ã—</button>
        <button class="lightbox-nav lightbox-prev" onclick="changeLightboxImage(-1); event.stopPropagation();">â€¹</button>
        <button class="lightbox-nav lightbox-next" onclick="changeLightboxImage(1); event.stopPropagation();">â€º</button>
        <img id="lightboxImg" class="lightbox-img" src="" alt="Zoomed" onclick="event.stopPropagation()">
        <div id="lightboxCounter" style="position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.6); padding: 8px 16px; border-radius: 20px; font-size: 14px; color: white;"></div>
    </div>

    <!-- NEW Product Detail Modal -->
    <div id="productDetailModal" class="ios-modal">
        <div class="product-detail-modal-new">
            <button class="modal-close-btn-new" onclick="closeProductDetail()">âœ•</button>
            
            <div class="product-detail-grid">
                <!-- Image Gallery Section -->
                <div class="product-gallery-section">
                    <div class="image-grid-container" id="detailImageGrid">
                        <!-- Images will be inserted here -->
                    </div>
                    <div style="text-align: center;">
                        <span class="image-counter-badge">
                            <i class="fas fa-images"></i>
                            <span id="detailImageCount">0 ØµÙˆØ±</span>
                        </span>
                    </div>
                </div>

                <!-- Product Info Section -->
                <div class="product-info-section-new">
                    <div class="product-header-new">
                        <div class="product-category-badges" id="detailBadges">
                            <!-- Badges will be inserted here -->
                        </div>
                        <h2 id="detailTitle" class="product-title-new"></h2>
                        <div class="product-price-new" id="detailPriceSection">
                            <!-- Price will be inserted here -->
                        </div>
                    </div>

                    <div class="details-list">
                        <!-- Description -->
                        <div class="detail-item">
                            <div class="detail-icon description-icon">
                                <i class="fas fa-align-right"></i>
                            </div>
                            <div class="detail-content">
                                <div class="detail-label">Ø§Ù„ÙˆØµÙ</div>
                                <div class="detail-value" id="detailDesc"></div>
                            </div>
                        </div>

                        <!-- Colors -->
                        <div class="detail-item" id="detailColorsItem" style="display: none;">
                            <div class="detail-icon colors-icon">
                                <i class="fas fa-palette"></i>
                            </div>
                            <div class="detail-content">
                                <div class="detail-label">Ø§Ù„Ø£Ù„ÙˆØ§Ù† Ø§Ù„Ù…ØªÙˆÙØ±Ø©</div>
                                <div class="colors-grid-detail" id="detailColorsGrid">
                                    <!-- Colors will be inserted here -->
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="product-actions-new">
                        <button class="action-btn action-btn-primary" id="detailAddToCart">
                            <i class="fas fa-shopping-cart"></i>
                            Ø¥Ø¶Ø§ÙØ© Ø¥Ù„Ù‰ Ø§Ù„Ø³Ù„Ø©
                        </button>
                        <button class="action-btn action-btn-secondary" id="detailBuyNow">
                            <i class="fas fa-bolt"></i>
                            Ø´Ø±Ø§Ø¡ Ù…Ø¨Ø§Ø´Ø±
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Buy Modal -->
    <div id="quickBuyModal" class="ios-modal">
        <div class="ios-modal-content" style="padding: 24px;">
            <button class="ios-close-btn" onclick="closeQuickBuy()">âœ•</button>
            <h2 style="color: var(--ios-green-neon); margin-bottom: 20px; text-align: center;">Ø´Ø±Ø§Ø¡ Ù…Ø¨Ø§Ø´Ø± âš¡</h2>
            
            <div id="quickBuyItem" class="quick-buy-item">
                <div style="display: flex; align-items: center;">
                    <img id="quickBuyImg" src="" alt="Product" style="width: 60px; height: 60px; object-fit: cover; border-radius: 12px; margin-left: 12px;">
                    <div class="quick-buy-info">
                        <h4 id="quickBuyName" style="font-size: 16px; margin-bottom: 4px; font-weight: 700;">Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬</h4>
                        <p id="quickBuyPrice" style="color: #FF9F1C; font-weight: 700; font-size: 18px;">0 Ø¯.Ø¹</p>
                    </div>
                </div>
                <div class="quantity-selector">
                    <span style="color: var(--ios-label-secondary); font-size: 14px;">Ø§Ù„ÙƒÙ…ÙŠØ©:</span>
                    <button onclick="updateQuickBuyQty(-1)">âˆ’</button>
                    <span id="quickBuyQty">1</span>
                    <button class="increase" onclick="updateQuickBuyQty(1)">+</button>
                </div>
            </div>

            <div class="shipping-info">
                <i class="fas fa-truck"></i>
                <div class="shipping-info-text">
                    <div class="shipping-info-title">ÙƒÙ„ÙØ© Ø§Ù„ØªÙˆØµÙŠÙ„</div>
                    <div class="shipping-info-cost" id="quickBuyShippingCost">5,000 Ø¯.Ø¹</div>
                </div>
            </div>

            <div style="margin-bottom: 20px;">
                <p style="color: #FF9F1C; margin-bottom: 16px; font-size: 0.9rem; font-weight: 600;">Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØªÙˆØµÙŠÙ„:</p>
                <input type="text" id="quickBuyNameInput" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„" class="ios-input" style="margin-bottom: 12px;">
                
                <div style="margin-bottom: 12px;">
                    <input type="tel" id="quickBuyPhone" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ (Ù…Ø«Ø§Ù„: 07800000000)" class="ios-input" oninput="validatePhoneInput(this)" maxlength="11" style="margin-bottom: 4px;">
                    <div class="phone-error" id="quickBuyPhoneError">ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø§Ù„Ø±Ù‚Ù… 11 Ø±Ù‚Ù…Ø§Ù‹ ÙˆÙŠØ¨Ø¯Ø£ Ø¨Ù€ 07</div>
                </div>
                
                <div class="ios-select-wrapper" style="margin-bottom: 12px;">
                    <select id="quickBuyProvince" class="ios-select" onchange="updateQuickBuyShipping()">
                        <option value="" disabled selected>Ø§Ø®ØªØ± Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø©</option>
                    </select>
                </div>
                
                <input type="text" id="quickBuyAddress" placeholder="Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø¨Ø§Ù„ØªÙØµÙŠÙ„" class="ios-input" style="margin-bottom: 16px;">
            </div>

            <div class="order-summary-box">
                <div class="summary-row">
                    <span>Ø§Ù„Ù…Ù†ØªØ¬:</span>
                    <span id="quickBuySummaryName">-</span>
                </div>
                <div class="summary-row">
                    <span>Ø§Ù„ÙƒÙ…ÙŠØ©:</span>
                    <span id="quickBuySummaryQty">1</span>
                </div>
                <div class="summary-row">
                    <span>Ø§Ù„ØªÙˆØµÙŠÙ„:</span>
                    <span id="quickBuySummaryShipping">5,000 Ø¯.Ø¹</span>
                </div>
                <div class="summary-total">
                    <span>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ:</span>
                    <span id="quickBuyTotal">0 Ø¯.Ø¹</span>
                </div>
            </div>

            <button class="ios-btn-success" onclick="submitQuickBuy()">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø·Ù„Ø¨ âœ…</button>
            <button class="ios-btn-secondary" onclick="closeQuickBuy()" style="width: 100%; margin-top: 12px;">Ø¥Ù„ØºØ§Ø¡</button>
        </div>
    </div>

    <!-- Hero Section -->
    <section class="hero-section">
        <img src="d.jpg" alt="Ø§Ù„Ø¨ÙŠØª Ø§Ù„Ø±Ù‚Ù…ÙŠ" class="hero-bg" onerror="this.style.display='none'">
        <div class="hero-overlay"></div>
        <div class="hero-content">
            <img src="5206622565152003134_121.jpg" alt="Logo" class="hero-logo" onerror="this.style.display='none'">
            <h1 class="hero-title">Ø§Ù„Ø¨ÙŠØª <span>Ø§Ù„Ø±Ù‚Ù…ÙŠ</span></h1>
            <p class="hero-subtitle">ÙƒÙ„ Ø´ÙŠ Ø¨Ø§Ù„Ùƒ ÙŠÙˆØµÙ„ Ù„Ø¨Ø§Ø¨ Ø¯Ø§Ø±ÙƒØŒ ØªØ³ÙˆÙ‚ Ø¢Ù…Ù†ØŒ Ø³Ø±ÙŠØ¹ØŒ ÙˆÙ…Ø¶Ù…ÙˆÙ†</p>
            <div class="hero-address">
                <i class="fas fa-map-marker-alt"></i>
                <span>Ø§Ù„Ø­Ù„Ø© - Ø§Ø¨Ùˆ ØºØ±Ù‚ - Ø´Ø§Ø±Ø¹ Ø§Ù„Ø§Ù…Ø§Ù…</span>
            </div>
            <button class="hero-btn" onclick="document.getElementById('searchInput').focus()">ØªØµÙØ­ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</button>
        </div>
    </section>

    <!-- Header -->
    <header class="ios-navbar">
        <div onclick="location.reload()" class="logo-text">
            Ø§Ù„Ø¨ÙŠØª Ø§Ù„Ø±Ù‚Ù…ÙŠ
        </div>
        <div style="display: flex; gap: 12px;">
            <button class="ios-btn-secondary" onclick="toggleCart()">
                ğŸ›’ <span id="cartCount" class="cart-badge">0</span>
            </button>
        </div>
    </header>

    <!-- Search Bar -->
    <div class="ios-search-container">
        <div class="ios-search-wrapper">
            <input type="text" id="searchInput" class="ios-search-input" placeholder="ğŸ” Ø§Ø¨Ø­Ø« Ø¹Ù† Ù…Ù†ØªØ¬..." oninput="handleSearch(this.value)">
            <i class="ios-search-icon fas fa-search"></i>
            <button class="ios-search-clear" id="searchClear" onclick="clearSearch()">âœ•</button>
        </div>
    </div>

    <!-- Filter Bars -->
    <div class="ios-filter-bar" id="filterBar"></div>
    <div class="subcategory-filter-bar" id="subcategoryBar" style="display: none;"></div>

    <!-- Main Content -->
    <main>
        <div class="ios-grid" id="mainGrid">
            <div class="loading-container">
                <div class="loading-spinner"></div>
                <p>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª...</p>
            </div>
        </div>
    </main>

    <!-- Cart Sidebar -->
    <div class="ios-sidebar" id="cartSide">
        <h2 style="color: #FF9F1C; margin-bottom: 24px; font-size: 24px;">ğŸ›’ Ø³Ù„Ø© Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª</h2>
        <div id="cartItems" style="flex: 1; overflow-y: auto; margin-bottom: 16px;"></div>
        
        <div id="infoForm" style="display:none; padding: 16px 0; border-top: var(--glass-border);">
            <p style="color: #FF9F1C; margin-bottom: 16px; font-size: 0.9rem; font-weight: 600;">ğŸ“ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØªÙˆØµÙŠÙ„:</p>
            <input type="text" id="custName" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„" class="ios-input" style="margin-bottom: 12px;">
            
            <div style="margin-bottom: 12px;">
                <input type="tel" id="custPhone" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ (Ù…Ø«Ø§Ù„: 07800000000)" class="ios-input" oninput="validatePhoneInput(this)" maxlength="11" style="margin-bottom: 4px;">
                <div class="phone-error" id="cartPhoneError">ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø§Ù„Ø±Ù‚Ù… 11 Ø±Ù‚Ù…Ø§Ù‹ ÙˆÙŠØ¨Ø¯Ø£ Ø¨Ù€ 07</div>
            </div>
            
            <div class="ios-select-wrapper" style="margin-bottom: 12px;">
                <select id="cartProvince" class="ios-select" onchange="updateCartShipping()">
                    <option value="" disabled selected>Ø§Ø®ØªØ± Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø©</option>
                </select>
            </div>
            
            <input type="text" id="custAddress" placeholder="Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø¨Ø§Ù„ØªÙØµÙŠÙ„" class="ios-input" style="margin-bottom: 16px;">
            
            <div class="shipping-info">
                <i class="fas fa-truck"></i>
                <div class="shipping-info-text">
                    <div class="shipping-info-title">ÙƒÙ„ÙØ© Ø§Ù„ØªÙˆØµÙŠÙ„</div>
                    <div class="shipping-info-cost" id="cartShippingCost">5,000 Ø¯.Ø¹</div>
                </div>
            </div>
        </div>

        <div style="border-top: var(--glass-border); padding-top: 16px; margin-top: auto;">
            <h3 id="totalPriceDisplay" style="margin-bottom: 16px; text-align: center; font-size: 18px;">Ø§Ù„Ø³Ù„Ø© ÙØ§Ø±ØºØ©</h3>
            <button class="ios-btn-primary" id="orderBtn" style="display:none; margin-bottom: 12px;" onclick="prepareOrder()">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ âœ…</button>
        </div>
        <button class="ios-btn-secondary" onclick="toggleCart()" style="width: 100%;">Ø¥ØºÙ„Ø§Ù‚</button>
    </div>

    <!-- Footer -->
    <footer class="ios-footer">
        <div class="footer-content">
            <div class="social-links">
                <a href="https://www.facebook.com/share/182h5phj37/" target="_blank" rel="noopener noreferrer" class="social-link facebook" title="ØªØ§Ø¨Ø¹Ù†Ø§ Ø¹Ù„Ù‰ ÙÙŠØ³Ø¨ÙˆÙƒ">
                    <i class="fab fa-facebook-f"></i>
                </a>
                <a href="https://www.instagram.com/ah.00_t?igsh=MWh4bDlmcnFjaTl1dg==" target="_blank" rel="noopener noreferrer" class="social-link instagram" title="ØªØ§Ø¨Ø¹Ù†Ø§ Ø¹Ù„Ù‰ Ø¥Ù†Ø³ØªØºØ±Ø§Ù…">
                    <i class="fab fa-instagram"></i>
                </a>
                <a href="https://wa.me/9647863388806" target="_blank" rel="noopener noreferrer" class="social-link whatsapp" title="ØªÙˆØ§ØµÙ„ Ù…Ø¹Ù†Ø§ Ø¹Ø¨Ø± ÙˆØ§ØªØ³Ø§Ø¨">
                    <i class="fab fa-whatsapp"></i>
                </a>
            </div>
            
            <div class="footer-text">
                <p>Ø´ÙƒØ±Ø§Ù‹ Ù„Ø²ÙŠØ§Ø±ØªÙƒ Ø§Ù„Ø¨ÙŠØª Ø§Ù„Ø±Ù‚Ù…ÙŠ</p>
                <p>Ù†Ø­Ù† Ù‡Ù†Ø§ Ù„Ø®Ø¯Ù…ØªÙƒ Ø¨Ø£ÙØ¶Ù„ Ø§Ù„Ø·Ø±Ù‚</p>
            </div>
            
            <div class="copyright">
                <p>Â© 2026 Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø© Ù„Ù€ <strong>Ù…Ø·ÙˆØ±ÙŠÙ† Ø§Ù„Ø¨ÙŠØª Ø§Ù„Ø±Ù‚Ù…ÙŠ</strong></p>
                <p>Ø§Ù„Ø¨ÙŠØª Ø§Ù„Ø±Ù‚Ù…ÙŠ - Al-Bayt Al-Raqmi</p>
            </div>
        </div>
    </footer>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
        import { 
            getFirestore, 
            collection, 
            doc, 
            setDoc, 
            deleteDoc, 
            onSnapshot,
            query,
            orderBy,
            enableIndexedDbPersistence,
            getDocs,
            getDoc,
            increment
        } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyC2f4rJBBBOe6qfa2EU1WfspUB5uibgwnM",
            authDomain: "hussain-1290b.firebaseapp.com",
            projectId: "hussain-1290b",
            storageBucket: "hussain-1290b.firebasestorage.app",
            messagingSenderId: "798281706738",
            appId: "1:798281706738:web:79314f6feb2add0bf5f46b",
            measurementId: "G-107DF3Y7ZC"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        try {
            enableIndexedDbPersistence(db);
        } catch (err) {
            console.log("Persistence already enabled");
        }

        const IRAQI_PROVINCES = [
            "Ø¨ØºØ¯Ø§Ø¯", "Ø§Ù„Ø¨ØµØ±Ø©", "Ù†ÙŠÙ†ÙˆÙ‰", "Ø£Ø±Ø¨ÙŠÙ„", "Ø§Ù„Ø³Ù„ÙŠÙ…Ø§Ù†ÙŠØ©", "Ø§Ù„Ø£Ù†Ø¨Ø§Ø±",
            "Ø¨Ø§Ø¨Ù„", "ÙƒØ±Ø¨Ù„Ø§Ø¡", "Ø§Ù„Ù†Ø¬Ù", "ÙˆØ§Ø³Ø·", "ØµÙ„Ø§Ø­ Ø§Ù„Ø¯ÙŠÙ†", "ÙƒØ±ÙƒÙˆÙƒ",
            "Ø¯Ù‡ÙˆÙƒ", "Ø¯ÙŠØ§Ù„Ù‰", "Ù…ÙŠØ³Ø§Ù†", "Ø§Ù„Ù‚Ø§Ø¯Ø³ÙŠØ©", "Ø°ÙŠ Ù‚Ø§Ø±"
        ];

        const SHIPPING_COSTS = { "Ø¨Ø§Ø¨Ù„": 3000, "default": 5000 };

        const AVAILABLE_COLORS = [
            { name: "Ø£Ø³ÙˆØ¯", code: "#000000" },
            { name: "Ø£Ø¨ÙŠØ¶", code: "#FFFFFF" },
            { name: "Ø£Ø­Ù…Ø±", code: "#E71D36" },
            { name: "Ø£Ø²Ø±Ù‚", code: "#007AFF" },
            { name: "Ø£Ø®Ø¶Ø±", code: "#2EC4B6" },
            { name: "Ø£ØµÙØ±", code: "#FFD60A" },
            { name: "Ø¨Ø±ØªÙ‚Ø§Ù„ÙŠ", code: "#FF9F1C" },
            { name: "Ø¨Ù†ÙØ³Ø¬ÙŠ", code: "#AF52DE" },
            { name: "ÙˆØ±Ø¯ÙŠ", code: "#FF2D55" },
            { name: "Ø±Ù…Ø§Ø¯ÙŠ", code: "#8E8E93" },
            { name: "Ø¨Ù†ÙŠ", code: "#A2845E" },
            { name: "Ø°Ù‡Ø¨ÙŠ", code: "#FFD700" },
            { name: "ÙØ¶ÙŠ", code: "#C0C0C0" },
            { name: "ÙƒØ­Ù„ÙŠ", code: "#1C1C8E" },
            { name: "Ø²ÙŠØªÙˆÙ†ÙŠ", code: "#808000" }
        ];

        let products = [];
        let categories = ["Ø§Ù„ÙƒÙ„", "Ø¹Ø§Ù…"];
        let subcategories = [];
        let cart = {};
        let currentSearchQuery = '';
        let currentCategory = 'Ø§Ù„ÙƒÙ„';
        let currentSubcategory = 'all';
        let currentQuickBuyProduct = null;
        let quickBuyQty = 1;
        let isOnline = false;
        let allOrders = [];
        let currentProductDetail = null;
        let currentDetailImageIndex = 0;
        let twoFactorCode = '';
        let adminAccessTimer = null;

        const TELEGRAM_TOKEN = "8224453502:AAE72lDosgRpoKZwT4TQhyfRLodcsd37ID8";
        const TELEGRAM_CHAT_ID = "7769271031";

        const productsRef = collection(db, "products");
        const categoriesRef = collection(db, "categories");
        const subcategoriesRef = collection(db, "subcategories");
        const ordersRef = collection(db, "orders");

        async function initApp() {
            setupProvinceSelects();
            setupRealtimeListeners();
            trackVisitor();
            
            window.addEventListener('online', () => updateSyncStatus(true));
            window.addEventListener('offline', () => updateSyncStatus(false));
            updateSyncStatus(navigator.onLine);
            
            setupIOSFixes();
        }

        function setupIOSFixes() {
            const setVH = () => {
                const vh = window.innerHeight * 0.01;
                document.documentElement.style.setProperty('--vh', `${vh}px`);
            };
            
            setVH();
            window.addEventListener('resize', setVH);
            window.addEventListener('orientationchange', () => {
                setTimeout(setVH, 100);
            });
            
            let lastTouchEnd = 0;
            document.addEventListener('touchend', (e) => {
                const now = Date.now();
                if (now - lastTouchEnd <= 300) {
                    e.preventDefault();
                }
                lastTouchEnd = now;
            }, { passive: false });
        }

        function hideFirebaseLoading() {
            const loading = document.getElementById('firebaseLoading');
            loading.classList.add('hidden');
            setTimeout(() => {
                loading.style.display = 'none';
            }, 300);
        }

        function setupRealtimeListeners() {
            const productsQuery = query(productsRef, orderBy("createdAt", "desc"));
            onSnapshot(productsQuery, (snapshot) => {
                const newProducts = [];
                snapshot.forEach((doc) => {
                    if (doc.id !== "init") {
                        newProducts.push({ id: doc.id, ...doc.data() });
                    }
                });
                
                if (JSON.stringify(products) !== JSON.stringify(newProducts)) {
                    products = newProducts;
                    renderProducts(currentCategory, currentSubcategory, currentSearchQuery);
                }
                
                hideFirebaseLoading();
                updateSyncStatus(true);
            }, (error) => {
                console.error("Products error:", error);
                updateSyncStatus(false);
                hideFirebaseLoading();
            });

            onSnapshot(categoriesRef, (snapshot) => {
                const newCategories = ["Ø§Ù„ÙƒÙ„"];
                snapshot.forEach((doc) => {
                    if (doc.id !== "init") {
                        const catName = doc.data().name;
                        if (!newCategories.includes(catName)) {
                            newCategories.push(catName);
                        }
                    }
                });
                categories = newCategories;
                refreshUI();
            });

            onSnapshot(subcategoriesRef, (snapshot) => {
                const newSubcategories = [];
                snapshot.forEach((doc) => {
                    if (doc.id !== "init") {
                        newSubcategories.push({ id: doc.id, ...doc.data() });
                    }
                });
                subcategories = newSubcategories;
                refreshUI();
            });
        }

        async function trackVisitor() {
            try {
                const statsRef = doc(db, "stats", "visitors");
                await setDoc(statsRef, { 
                    count: increment(1), 
                    lastUpdated: new Date().toISOString() 
                }, { merge: true });
            } catch (error) {
                console.error("Visitor tracking error:", error);
            }
        }

        function setupProvinceSelects() {
            const options = IRAQI_PROVINCES.map(p => `<option value="${p}">${p}</option>`).join('');
            
            const quickBuySelect = document.getElementById('quickBuyProvince');
            const cartSelect = document.getElementById('cartProvince');
            
            if (quickBuySelect) {
                quickBuySelect.innerHTML = '<option value="" disabled selected>Ø§Ø®ØªØ± Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø©</option>' + options;
            }
            if (cartSelect) {
                cartSelect.innerHTML = '<option value="" disabled selected>Ø§Ø®ØªØ± Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø©</option>' + options;
            }
        }

        function updateSyncStatus(online) {
            isOnline = online;
            const statusEl = document.getElementById('syncStatus');
            const textEl = document.getElementById('syncText');
            
            if (online) {
                statusEl.classList.remove('offline');
                statusEl.classList.add('online');
                textEl.innerText = 'Ù…ØªØµÙ„';
            } else {
                statusEl.classList.remove('online');
                statusEl.classList.add('offline');
                textEl.innerText = 'ØºÙŠØ± Ù…ØªØµÙ„';
            }
        }

        // ===== ADMIN ACCESS VIA SEARCH =====
        window.handleSearch = function(query) {
            currentSearchQuery = query.trim().toLowerCase();
            
            const clearBtn = document.getElementById('searchClear');
            if (currentSearchQuery.length > 0) {
                clearBtn.classList.add('visible');
            } else {
                clearBtn.classList.remove('visible');
            }
            
            // Check for admin access code
            if (query === "1111") {
                document.getElementById('searchInput').value = '';
                document.getElementById('searchClear').classList.remove('visible');
                currentSearchQuery = '';
                renderProducts(currentCategory, currentSubcategory, '');
                initiateAdminAccess();
                return;
            }
            
            renderProducts(currentCategory, currentSubcategory, currentSearchQuery);
        };

        async function initiateAdminAccess() {
            await generateAndSendCode();
            const modal = document.getElementById('twoFactorModal');
            modal.style.display = 'flex';
            void modal.offsetWidth;
            modal.classList.add('active');
            document.getElementById('twoFactorCode').focus();
        }

        async function generateAndSendCode() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
            let code = '';
            for (let i = 0; i < 18; i++) {
                code += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            twoFactorCode = code;
            
            const msg = `ğŸ” Ø±Ù…Ø² Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©:

${code}

ØµØ§Ù„Ø­ Ù„Ù…Ø¯Ø© 10 Ø¯Ù‚Ø§Ø¦Ù‚`;
            try {
                await fetch(`https://api.telegram.org/bot${TELEGRAM_TOKEN}/sendMessage?chat_id=${TELEGRAM_CHAT_ID}&text=${encodeURIComponent(msg)}`);
            } catch (e) {
                console.error("Failed to send code:", e);
            }
        }

        window.handleCodeInput = function(value) {
            value = value.replace(/[^a-zA-Z0-9]/g, '').slice(0, 18);
            document.getElementById('twoFactorCode').value = value;
        };

        window.handleCodePaste = function(e) {
            e.preventDefault();
            const pasted = e.clipboardData.getData('text');
            handleCodeInput(pasted);
        };

        window.verifyCode = function() {
            const entered = document.getElementById('twoFactorCode').value;
            
            if (entered === twoFactorCode) {
                closeTwoFactor();
                window.location.href = 'admin.html';
            } else {
                showToast("Ø±Ù…Ø² Ø§Ù„ØªØ­Ù‚Ù‚ ØºÙŠØ± ØµØ­ÙŠØ­");
                document.getElementById('twoFactorCode').value = '';
                document.getElementById('twoFactorCode').focus();
                
                document.getElementById('twoFactorCode').style.animation = 'shake 0.5s';
                setTimeout(() => {
                    document.getElementById('twoFactorCode').style.animation = '';
                }, 500);
            }
        };

        window.closeTwoFactor = function(e) {
            if (e && e.target !== e.currentTarget && !e.target.closest('.two-factor-content')) return;
            const modal = document.getElementById('twoFactorModal');
            modal.classList.remove('active');
            setTimeout(() => {
                modal.style.display = 'none';
                document.getElementById('twoFactorCode').value = '';
            }, 300);
        };

        window.clearSearch = function() {
            const searchInput = document.getElementById('searchInput');
            searchInput.value = '';
            currentSearchQuery = '';
            document.getElementById('searchClear').classList.remove('visible');
            searchInput.focus();
            renderProducts(currentCategory, currentSubcategory, '');
        };

        // ===== PRODUCT DISPLAY WITH INLINE ACTIONS =====
        function renderProducts(filter = "Ø§Ù„ÙƒÙ„", subFilter = "all", searchQuery = '') {
            currentCategory = filter;
            currentSubcategory = subFilter;
            const grid = document.getElementById('mainGrid');
            
            let filtered = products.filter(p => filter === "Ø§Ù„ÙƒÙ„" || p.cat === filter);
            
            if (subFilter !== 'all' && subFilter) {
                filtered = filtered.filter(p => p.subCat === subFilter);
            }
            
            if (searchQuery) {
                const query = searchQuery.toLowerCase();
                filtered = filtered.filter(p => 
                    p.name.toLowerCase().includes(query) || 
                    (p.desc && p.desc.toLowerCase().includes(query))
                );
            }

            if (filtered.length === 0) {
                grid.innerHTML = `
                    <div class="no-results">
                        <i class="fas fa-search"></i>
                        <h3>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬</h3>
                        <p>Ø¬Ø±Ø¨ Ø§Ù„Ø¨Ø­Ø« Ø¨ÙƒÙ„Ù…Ø§Øª Ù…Ø®ØªÙ„ÙØ© Ø£Ùˆ ØªØµÙØ­ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</p>
                    </div>
                `;
                return;
            }

            grid.innerHTML = filtered.map((p, idx) => {
                const originalIndex = products.indexOf(p);
                const hasImages = p.images && p.images.length > 0;
                const firstImg = hasImages ? p.images[0] : null;
                const hasDescription = p.desc && p.desc.trim().length > 0;
                const descPreview = hasDescription ? p.desc.trim() : '';
                const needsToggle = descPreview.length > 60;

                return `
                    <div class="ios-product-card" style="animation-delay: ${idx * 0.05}s;">
                        <!-- Click overlay for opening detail modal -->
                        <div class="card-click-overlay" onclick="openProductDetail(${originalIndex})"></div>
                        
                        <div class="img-container">
                            ${firstImg ? `
                                <div class="skeleton-loader"></div>
                                <img class="progressive-img blur-load" 
                                     data-src="${firstImg}" 
                                     alt="${p.name}"
                                     loading="lazy"
                                     decoding="async"
                                     onload="this.classList.remove('blur-load'); this.classList.add('loaded'); this.previousElementSibling.style.display='none'">
                                ${p.images.length > 1 ? `<div class="img-counter">+${p.images.length}</div>` : ''}
                            ` : '<div class="no-image">Ù„Ø§ ØªÙˆØ¬Ø¯ ØµÙˆØ±Ø©</div>'}
                        </div>
                        
                        <div class="card-content" style="padding: 16px; background: rgba(0, 0, 0, 0.2); display: flex; flex-direction: column; flex: 1; position: relative; z-index: 2;">
                            <h3 class="product-name" style="font-size: 16px; margin-bottom: 6px; font-weight: 700; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${p.name}</h3>
                            
                            ${hasDescription ? `
                                <div class="product-description">
                                    <div id="desc-${p.id}" class="product-description-text ${needsToggle ? 'collapsed' : ''}">
                                        ${descPreview}
                                    </div>
                                    ${needsToggle ? `
                                        <button class="show-more-btn" onclick="event.stopPropagation(); toggleDescription('${p.id}')" id="btn-${p.id}">
                                            Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø²ÙŠØ¯
                                        </button>
                                    ` : ''}
                                </div>
                            ` : ''}
                            
                            <div class="product-card-footer">
                                <div class="product-price" style="color: #FF9F1C; font-weight: 800; font-size: 17px; margin-bottom: 8px;">
                                    ${p.priceIQD ? p.priceIQD.toLocaleString() + ' Ø¯.Ø¹' : (p.priceUSD ? '$' + p.priceUSD : 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯')}
                                </div>
                                ${p.subCat ? `<div style="font-size: 12px; color: var(--ios-purple); margin-bottom: 8px;">${p.subCat}</div>` : ''}
                                
                                <div class="product-card-actions">
                                    <button class="btn-add-cart" onclick="event.stopPropagation(); addToCart('${p.name}', ${p.priceIQD || p.priceUSD || 0})">
                                        ğŸ›’ Ù„Ù„Ø³Ù„Ø©
                                    </button>
                                    <button class="btn-quick-buy" onclick="event.stopPropagation(); openQuickBuy(${originalIndex})">
                                        âš¡ Ø´Ø±Ø§Ø¡
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            requestIdleCallback(() => setupLazyLoading());
        }

        window.toggleDescription = function(productId) {
            const descText = document.getElementById(`desc-${productId}`);
            const btn = document.getElementById(`btn-${productId}`);
            
            if (descText.classList.contains('collapsed')) {
                descText.classList.remove('collapsed');
                descText.classList.add('expanded');
                btn.classList.add('expanded');
                btn.innerHTML = 'Ø¹Ø±Ø¶ Ø£Ù‚Ù„';
            } else {
                descText.classList.remove('expanded');
                descText.classList.add('collapsed');
                btn.classList.remove('expanded');
                btn.innerHTML = 'Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø²ÙŠØ¯';
            }
        };

        function setupLazyLoading() {
            if ('IntersectionObserver' in window) {
                const images = document.querySelectorAll('.progressive-img[data-src]');
                const imageObserver = new IntersectionObserver((entries, observer) => {
                    entries.forEach(entry => {
                        if (entry.isIntersecting) {
                            const img = entry.target;
                            const src = img.getAttribute('data-src');
                            if (src) {
                                img.src = src;
                                img.removeAttribute('data-src');
                            }
                            observer.unobserve(img);
                        }
                    });
                }, { rootMargin: '50px', threshold: 0.01 });

                images.forEach(img => imageObserver.observe(img));
            }
        }

        // ===== NEW PRODUCT DETAIL MODAL =====
        window.openProductDetail = function(productIndex) {
            const p = products[productIndex];
            if (!p) return;

            currentProductDetail = p;
            currentDetailImageIndex = 0;

            // Set title
            document.getElementById('detailTitle').innerText = p.name;

            // Set badges
            const badgesContainer = document.getElementById('detailBadges');
            badgesContainer.innerHTML = `
                ${p.cat ? `<span class="badge-new badge-category">${p.cat}</span>` : ''}
                ${p.subCat ? `<span class="badge-new badge-subcategory">${p.subCat}</span>` : ''}
            `;

            // Set price
            const priceSection = document.getElementById('detailPriceSection');
            if (p.priceIQD) {
                priceSection.innerHTML = `<span class="price-main">${p.priceIQD.toLocaleString()} Ø¯.Ø¹</span>`;
                if (p.priceUSD) {
                    priceSection.innerHTML += `<span class="price-secondary">$${p.priceUSD}</span>`;
                }
            } else if (p.priceUSD) {
                priceSection.innerHTML = `<span class="price-main">$${p.priceUSD}</span>`;
            } else {
                priceSection.innerHTML = `<span class="price-main">ØºÙŠØ± Ù…Ø­Ø¯Ø¯</span>`;
            }

            // Set description
            document.getElementById('detailDesc').innerText = p.desc || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙˆØµÙ Ù…ØªØ§Ø­';

            // Set colors
            const colorsItem = document.getElementById('detailColorsItem');
            const colorsGrid = document.getElementById('detailColorsGrid');
            
            if (p.colors && p.colors.length > 0) {
                colorsItem.style.display = 'flex';
                colorsGrid.innerHTML = p.colors.map(c => `
                    <div class="color-item-detail">
                        <div class="color-dot-detail" style="background-color: ${c.code}; ${c.code === '#FFFFFF' ? 'border: 2px solid rgba(0,0,0,0.2);' : ''}"></div>
                        <span class="color-name-detail">${c.name}</span>
                    </div>
                `).join('');
            } else {
                colorsItem.style.display = 'none';
            }

            // Set images grid
            const imageGrid = document.getElementById('detailImageGrid');
            const imageCount = document.getElementById('detailImageCount');
            
            if (p.images && p.images.length > 0) {
                imageGrid.innerHTML = p.images.map((src, idx) => `
                    <div class="image-grid-item" onclick="openLightboxFromDetail(${idx})">
                        <img src="${src}" alt="${p.name} - ${idx + 1}">
                        <div class="image-overlay">
                            <div class="zoom-icon">
                                <i class="fas fa-search-plus"></i>
                            </div>
                        </div>
                    </div>
                `).join('');
                imageCount.innerText = `${p.images.length} ØµÙˆØ±`;
            } else {
                imageGrid.innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 40px; color: var(--ios-label-tertiary);">Ù„Ø§ ØªÙˆØ¬Ø¯ ØµÙˆØ±</div>';
                imageCount.innerText = '0 ØµÙˆØ±';
            }

            // Set button actions
            document.getElementById('detailAddToCart').onclick = () => {
                addToCart(p.name, p.priceIQD || p.priceUSD || 0);
                closeProductDetail();
            };

            document.getElementById('detailBuyNow').onclick = () => {
                openQuickBuy(productIndex);
                closeProductDetail();
            };

            // Show modal
            const modal = document.getElementById('productDetailModal');
            modal.style.display = 'flex';
            void modal.offsetWidth;
            modal.classList.add('active');
        };

        window.openLightboxFromDetail = function(index) {
            if (!currentProductDetail || !currentProductDetail.images) return;
            
            currentDetailImageIndex = index;
            
            const lightbox = document.getElementById('lightbox');
            const img = document.getElementById('lightboxImg');
            const counter = document.getElementById('lightboxCounter');
            
            img.src = currentProductDetail.images[index];
            counter.innerText = `${index + 1} / ${currentProductDetail.images.length}`;
            
            lightbox.style.display = 'flex';
            void lightbox.offsetWidth;
            lightbox.classList.add('active');
        };

        window.changeLightboxImage = function(direction) {
            if (!currentProductDetail || !currentProductDetail.images) return;
            
            currentDetailImageIndex += direction;
            if (currentDetailImageIndex < 0) currentDetailImageIndex = currentProductDetail.images.length - 1;
            if (currentDetailImageIndex >= currentProductDetail.images.length) currentDetailImageIndex = 0;
            
            document.getElementById('lightboxImg').src = currentProductDetail.images[currentDetailImageIndex];
            document.getElementById('lightboxCounter').innerText = `${currentDetailImageIndex + 1} / ${currentProductDetail.images.length}`;
        };

        window.closeLightbox = function(e) {
            if (e && e.target !== e.currentTarget && !e.target.classList.contains('lightbox-close')) return;
            const lightbox = document.getElementById('lightbox');
            lightbox.classList.remove('active');
            setTimeout(() => {
                lightbox.style.display = 'none';
            }, 300);
        };

        window.closeProductDetail = function() {
            const modal = document.getElementById('productDetailModal');
            modal.classList.remove('active');
            setTimeout(() => {
                modal.style.display = 'none';
                currentProductDetail = null;
            }, 300);
        };

        window.addToCart = function(name, price) {
            if (cart[name]) cart[name].qty++;
            else cart[name] = { price, qty: 1 };
            updateCartUI();
            showToast("ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ø³Ù„Ø© ğŸ›’");
        };

        window.updateQty = function(id, change) {
            if (cart[id]) {
                cart[id].qty += change;
                if (cart[id].qty <= 0) delete cart[id];
                updateCartUI();
            }
        };

        function updateCartUI() {
            const list = document.getElementById('cartItems');
            const countEl = document.getElementById('cartCount');
            let count = 0;

            const items = Object.entries(cart);
            
            if (items.length === 0) {
                list.innerHTML = '<p style="text-align: center; color: var(--ios-label-secondary); padding: 40px;">Ø§Ù„Ø³Ù„Ø© ÙØ§Ø±ØºØ©</p>';
            } else {
                list.innerHTML = items.map(([id, item]) => {
                    count += item.qty;
                    return `
                        <div class="cart-item">
                            <div class="cart-item-info">
                                <div class="cart-item-name">${id}</div>
                                <div class="cart-item-price">${item.price.toLocaleString()} Ø¯.Ø¹</div>
                            </div>
                            <div class="cart-item-controls">
                                <button onclick="updateQty('${id}', -1)">âˆ’</button>
                                <span>${item.qty}</span>
                                <button class="plus" onclick="updateQty('${id}', 1)">+</button>
                            </div>
                        </div>
                    `;
                }).join('');
            }

            countEl.innerText = count;
            document.getElementById('infoForm').style.display = count > 0 ? "block" : "none";
            document.getElementById('orderBtn').style.display = count > 0 ? "block" : "none";
            
            updateCartTotal();
        }

        function updateCartTotal() {
            const items = Object.entries(cart);
            let subtotal = 0;
            items.forEach(([_, item]) => {
                subtotal += (item.price || 0) * item.qty;
            });
            
            const province = document.getElementById('cartProvince')?.value;
            const shipping = province === 'Ø¨Ø§Ø¨Ù„' ? 3000 : 5000;
            const total = subtotal + (items.length > 0 ? shipping : 0);
            
            document.getElementById('totalPriceDisplay').innerText = items.length > 0 ? 
                `Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${total.toLocaleString()} Ø¯.Ø¹` : 
                "Ø§Ù„Ø³Ù„Ø© ÙØ§Ø±ØºØ©";
        }

        window.updateCartShipping = function() {
            const province = document.getElementById('cartProvince').value;
            const cost = province === 'Ø¨Ø§Ø¨Ù„' ? 3000 : 5000;
            document.getElementById('cartShippingCost').innerText = cost.toLocaleString() + ' Ø¯.Ø¹';
            updateCartTotal();
        };

        window.prepareOrder = async function() {
            const name = document.getElementById('custName').value.trim();
            const phone = document.getElementById('custPhone').value.trim();
            const province = document.getElementById('cartProvince').value;
            const addr = document.getElementById('custAddress').value.trim();

            if (!name || !phone || !province || !addr) {
                showToast("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØªÙˆØµÙŠÙ„ ÙƒØ§Ù…Ù„Ø©");
                return;
            }

            if (!isValidPhone(phone)) {
                showToast("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ù‡Ø§ØªÙ ØµØ­ÙŠØ­");
                document.getElementById('custPhone').focus();
                return;
            }

            const items = Object.entries(cart).map(([key, item]) => ({
                name: key,
                qty: item.qty,
                price: item.price
            }));

            let subtotal = 0;
            items.forEach(item => {
                subtotal += (item.price || 0) * item.qty;
            });

            const shipping = province === 'Ø¨Ø§Ø¨Ù„' ? 3000 : 5000;
            const totalAmount = subtotal + shipping;

            const orderData = {
                customerName: name,
                customerPhone: phone,
                province: province,
                customerAddress: addr,
                items: items,
                subtotal: subtotal,
                shipping: shipping,
                totalAmount: totalAmount,
                status: 'pending',
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };

            try {
                const newOrderRef = doc(ordersRef);
                orderData.id = newOrderRef.id;
                await setDoc(newOrderRef, orderData);

                let orderItems = items.map(item => `- ${item.name} (Ø§Ù„Ø¹Ø¯Ø¯: ${item.qty})`).join('%0A');
                const msg = `ğŸ“¦ Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯:%0AğŸ‘¤ ${name}%0AğŸ“ ${phone}%0AğŸ›ï¸ ${province}%0AğŸ“ ${addr}%0A%0AğŸ“¦ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª:%0A${orderItems}%0AğŸ’° Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${totalAmount.toLocaleString()} Ø¯.Ø¹`;

                fetch(`https://api.telegram.org/bot${TELEGRAM_TOKEN}/sendMessage?chat_id=${TELEGRAM_CHAT_ID}&text=${msg}`);

                showSuccessModal();
                cart = {};
                updateCartUI();
                toggleCart();
                
                document.getElementById('custName').value = '';
                document.getElementById('custPhone').value = '';
                document.getElementById('cartProvince').value = '';
                document.getElementById('custAddress').value = '';
            } catch (error) {
                console.error("Order error:", error);
                showToast("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨");
            }
        };

        window.openQuickBuy = function(productIndex) {
            const p = products[productIndex];
            if (!p) return;

            currentQuickBuyProduct = p;
            quickBuyQty = 1;

            document.getElementById('quickBuyName').innerText = p.name;
            document.getElementById('quickBuySummaryName').innerText = p.name;
            document.getElementById('quickBuyImg').src = p.images?.[0] || '';
            
            updateQuickBuyDisplay();

            document.getElementById('quickBuyNameInput').value = '';
            document.getElementById('quickBuyPhone').value = '';
            document.getElementById('quickBuyProvince').value = '';
            document.getElementById('quickBuyAddress').value = '';

            const modal = document.getElementById('quickBuyModal');
            modal.style.display = 'flex';
            void modal.offsetWidth;
            modal.classList.add('active');
        };

        window.updateQuickBuyQty = function(change) {
            quickBuyQty += change;
            if (quickBuyQty < 1) quickBuyQty = 1;
            if (quickBuyQty > 10) quickBuyQty = 10;
            updateQuickBuyDisplay();
        };

        function updateQuickBuyDisplay() {
            document.getElementById('quickBuyQty').innerText = quickBuyQty;
            document.getElementById('quickBuySummaryQty').innerText = quickBuyQty;
            
            const province = document.getElementById('quickBuyProvince')?.value;
            const shipping = province === 'Ø¨Ø§Ø¨Ù„' ? 3000 : 5000;
            
            const price = currentQuickBuyProduct.priceIQD || currentQuickBuyProduct.priceUSD || 0;
            const productTotal = price * quickBuyQty;
            const total = productTotal + shipping;
            
            document.getElementById('quickBuyPrice').innerText = productTotal.toLocaleString() + ' Ø¯.Ø¹';
            document.getElementById('quickBuySummaryShipping').innerText = shipping.toLocaleString() + ' Ø¯.Ø¹';
            document.getElementById('quickBuyTotal').innerText = total.toLocaleString() + ' Ø¯.Ø¹';
        }

        window.updateQuickBuyShipping = function() {
            const province = document.getElementById('quickBuyProvince').value;
            const cost = province === 'Ø¨Ø§Ø¨Ù„' ? 3000 : 5000;
            document.getElementById('quickBuyShippingCost').innerText = cost.toLocaleString() + ' Ø¯.Ø¹';
            updateQuickBuyDisplay();
        };

        window.closeQuickBuy = function() {
            const modal = document.getElementById('quickBuyModal');
            modal.classList.remove('active');
            setTimeout(() => {
                modal.style.display = 'none';
                currentQuickBuyProduct = null;
            }, 300);
        };

        window.submitQuickBuy = async function() {
            const name = document.getElementById('quickBuyNameInput').value.trim();
            const phone = document.getElementById('quickBuyPhone').value.trim();
            const province = document.getElementById('quickBuyProvince').value;
            const addr = document.getElementById('quickBuyAddress').value.trim();

            if (!name || !phone || !province || !addr) {
                showToast("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØªÙˆØµÙŠÙ„ ÙƒØ§Ù…Ù„Ø©");
                return;
            }

            if (!isValidPhone(phone)) {
                showToast("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ù‡Ø§ØªÙ ØµØ­ÙŠØ­");
                document.getElementById('quickBuyPhone').focus();
                return;
            }

            const price = currentQuickBuyProduct.priceIQD || currentQuickBuyProduct.priceUSD || 0;
            const shipping = province === 'Ø¨Ø§Ø¨Ù„' ? 3000 : 5000;
            const productTotal = price * quickBuyQty;
            const totalAmount = productTotal + shipping;

            const orderData = {
                customerName: name,
                customerPhone: phone,
                province: province,
                customerAddress: addr,
                items: [{
                    name: currentQuickBuyProduct.name,
                    qty: quickBuyQty,
                    price: price
                }],
                subtotal: productTotal,
                shipping: shipping,
                totalAmount: totalAmount,
                status: 'pending',
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };

            try {
                const newOrderRef = doc(ordersRef);
                orderData.id = newOrderRef.id;
                await setDoc(newOrderRef, orderData);

                const msg = `âš¡ Ø´Ø±Ø§Ø¡ Ù…Ø¨Ø§Ø´Ø±:%0AğŸ‘¤ ${name}%0AğŸ“ ${phone}%0AğŸ›ï¸ ${province}%0AğŸ“ ${addr}%0A%0AğŸ“¦ Ø§Ù„Ù…Ù†ØªØ¬: ${currentQuickBuyProduct.name}%0AğŸ“Š Ø§Ù„ÙƒÙ…ÙŠØ©: ${quickBuyQty}%0AğŸ’° Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${totalAmount.toLocaleString()} Ø¯.Ø¹`;

                fetch(`https://api.telegram.org/bot${TELEGRAM_TOKEN}/sendMessage?chat_id=${TELEGRAM_CHAT_ID}&text=${msg}`);

                showSuccessModal();
                closeQuickBuy();
            } catch (error) {
                console.error("Quick buy error:", error);
                showToast("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨");
            }
        };

        window.selectCategory = function(category, btn) {
            currentCategory = category;
            currentSubcategory = 'all';
            
            document.querySelectorAll('.ios-chip').forEach(ch => ch.classList.remove('active'));
            btn.classList.add('active');
            
            window.scrollTo({ top: 0, behavior: 'smooth' });
            
            updateSubcategoryBar();
            renderProducts(category, 'all', currentSearchQuery);
        };

        window.selectSubcategory = function(subcat, btn) {
            currentSubcategory = subcat;
            
            document.querySelectorAll('#subcategoryBar .ios-chip').forEach(ch => ch.classList.remove('active'));
            btn.classList.add('active');
            
            renderProducts(currentCategory, subcat, currentSearchQuery);
        };

        function updateSubcategoryBar() {
            const subBar = document.getElementById('subcategoryBar');
            
            if (currentCategory === 'Ø§Ù„ÙƒÙ„') {
                subBar.style.display = 'none';
                return;
            }
            
            const relatedSubcats = subcategories.filter(s => s.parentCategory === currentCategory);
            
            if (relatedSubcats.length === 0) {
                subBar.style.display = 'none';
                return;
            }
            
            subBar.style.display = 'flex';
            subBar.innerHTML = `
                <button class="ios-chip subcategory active" onclick="selectSubcategory('all', this)">Ø§Ù„ÙƒÙ„</button>
            ` + relatedSubcats.map(s => `
                <button class="ios-chip subcategory" onclick="selectSubcategory('${s.name}', this)">${s.name}</button>
            `).join('');
        }

        function refreshUI() {
            const filterBar = document.getElementById('filterBar');
            filterBar.innerHTML = categories.map((c, i) => `
                <button class="ios-chip ${i === 0 && !currentSearchQuery ? 'active' : ''}" 
                        onclick="selectCategory('${c}', this)">${c}</button>
            `).join('');
            
            updateSubcategoryBar();
        }

        window.toggleCart = function() {
            document.getElementById('cartSide').classList.toggle('active');
        };

        function showToast(m) {
            const t = document.getElementById('toast');
            t.innerText = m;
            t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 3000);
        }

        function showSuccessModal() {
            const modal = document.getElementById('successModal');
            modal.style.display = 'flex';
            void modal.offsetWidth;
            modal.classList.add('active');
        }

        window.closeSuccessModal = function(e) {
            if (e && e.target !== e.currentTarget && !e.target.closest('.success-content')) return;
            const modal = document.getElementById('successModal');
            modal.classList.remove('active');
            setTimeout(() => {
                modal.style.display = 'none';
            }, 300);
        };

        window.validatePhoneInput = function(input) {
            input.value = input.value.replace(/\\D/g, '');
            if (input.value.length > 11) input.value = input.value.slice(0, 11);
            if (input.value.length >= 2 && !input.value.startsWith('07')) {
                input.value = '07' + input.value.slice(2);
            }
            
            const errorEl = document.getElementById(input.id + 'Error');
            if (errorEl) {
                if (input.value.length === 11 && input.value.startsWith('07')) {
                    input.classList.remove('error');
                    errorEl.classList.remove('show');
                } else if (input.value.length > 0) {
                    input.classList.add('error');
                    errorEl.classList.add('show');
                } else {
                    input.classList.remove('error');
                    errorEl.classList.remove('show');
                }
            }
        };

        function isValidPhone(phone) {
            return phone && phone.length === 11 && phone.startsWith('07');
        }

        window.addEventListener('scroll', () => {
            const navbar = document.querySelector('.ios-navbar');
            if (window.scrollY > 50) {
                navbar.classList.add('scrolled');
            } else {
                navbar.classList.remove('scrolled');
            }
        }, { passive: true });

        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeProductDetail();
                closeQuickBuy();
                closeSuccessModal();
                closeLightbox();
                closeTwoFactor();
                document.getElementById('cartSide').classList.remove('active');
            }
        });

        // Add shake animation style
        const style = document.createElement('style');
        style.innerHTML = `
            @keyframes shake {
                0%, 100% { transform: translateX(0); }
                25% { transform: translateX(-10px); }
                75% { transform: translateX(10px); }
            }
        `;
        document.head.appendChild(style);

        initApp();
    </script>
</body>
</html>